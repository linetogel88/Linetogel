<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Izin Keluar Linetgl</title>
  <link rel="shortcut icon" href="https://cdn-icons-png.flaticon.com/512/190/190411.png" type="image/x-icon">
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700&display=swap" rel="stylesheet">
  
  <style>
    :root {
      --bg-gradient: linear-gradient(135deg, #0f0c29, #302b63, #24243e);
      --glass-bg: rgba(255, 255, 255, 0.05);
      --glass-border: rgba(255, 255, 255, 0.1);
      --primary-glow: #00d2ff;
      --secondary-glow: #3a7bd5;
      --text-main: #ffffff;
      --text-muted: rgba(255, 255, 255, 0.6);
      --danger: #ff4757;
      --success: #2ed573;
      --warning: #ffa502;
    }

    body {
      font-family: 'Poppins', sans-serif;
      background: var(--bg-gradient);
      background-size: 400% 400%;
      animation: gradientBG 15s ease infinite;
      margin: 0;
      display: flex;
      justify-content: center;
      align-items: center;
      min-height: 100vh;
      overflow-x: hidden;
      color: var(--text-main);
    }

    @keyframes gradientBG {
      0% { background-position: 0% 50%; }
      50% { background-position: 100% 50%; }
      100% { background-position: 0% 50%; }
    }

    .background-image {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      object-fit: cover;
      z-index: -2;
      opacity: 0;
      transition: opacity 1.5s ease-in-out;
    }

    .background-image.active {
      opacity: 0.2;
      filter: blur(5px);
    }

    #loginForm {
      position: relative;
      width: 100%;
      max-width: 420px;
      padding: 40px;
      background: var(--glass-bg);
      backdrop-filter: blur(20px);
      border: 1px solid var(--glass-border);
      border-radius: 30px;
      box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.5);
      animation: slideUpFade 0.8s cubic-bezier(0.2, 0.8, 0.2, 1) forwards;
    }

    @keyframes slideUpFade {
      0% { opacity: 0; transform: translateY(30px) scale(0.95); }
      100% { opacity: 1; transform: translateY(0) scale(1); }
    }

    #loginForm .login-logo-wrapper {
      text-align: center;
      margin-bottom: 35px;
    }

    #loginForm .login-logo-wrapper img {
      width: 90px;
      height: auto;
      margin-bottom: 15px;
      filter: drop-shadow(0 0 15px rgba(0, 210, 255, 0.4));
    }

    #loginForm h2 {
      text-align: center;
      color: #ffffff;
      font-weight: 700;
      font-size: 26px;
      letter-spacing: 1px;
      margin: 0 0 8px 0;
      background: linear-gradient(to right, #fff, #a1c4fd);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
    }

    #loginForm .subtitle {
      text-align: center;
      color: var(--text-muted);
      font-size: 14px;
      margin-bottom: 35px;
      font-weight: 300;
    }

    .modern-input-group {
      position: relative;
      margin-bottom: 25px;
    }

    .modern-input-group i.icon-left {
      position: absolute;
      left: 18px;
      top: 50%;
      transform: translateY(-50%);
      color: var(--text-muted);
      font-size: 16px;
      transition: all 0.3s ease;
    }

    .modern-input-group input {
      width: 100%;
      background: rgba(0, 0, 0, 0.3);
      border: 1px solid var(--glass-border);
      padding: 16px 50px 16px 50px;
      border-radius: 16px;
      color: #fff;
      font-size: 15px;
      font-family: 'Poppins', sans-serif;
      box-sizing: border-box;
      transition: all 0.3s ease;
    }

    .modern-input-group input::placeholder {
      color: rgba(255, 255, 255, 0.3);
    }

    .modern-input-group input:focus {
      outline: none;
      background: rgba(0, 0, 0, 0.5);
      border-color: var(--primary-glow);
      box-shadow: 0 0 20px rgba(0, 210, 255, 0.15);
    }

    .modern-input-group input:focus + i.icon-left {
      color: var(--primary-glow);
      text-shadow: 0 0 10px var(--primary-glow);
    }

    .modern-input-group i.toggle-password {
      position: absolute;
      right: 18px;
      top: 50%;
      transform: translateY(-50%);
      color: var(--text-muted);
      cursor: pointer;
      font-size: 16px;
      transition: color 0.3s;
    }

    .modern-input-group i.toggle-password:hover {
      color: #fff;
    }

    #error-message, #ipWhitelistMessage {
      font-size: 13px;
      text-align: center;
      margin-top: -15px;
      margin-bottom: 20px;
      padding: 10px;
      border-radius: 10px;
      display: none;
    }

    #error-message {
      color: #ff6b6b;
      background: rgba(255, 71, 87, 0.1);
      border: 1px solid rgba(255, 71, 87, 0.2);
    }

    #loginButton {
      width: 100%;
      padding: 16px;
      background: linear-gradient(135deg, #00d2ff 0%, #3a7bd5 100%);
      border: none;
      border-radius: 16px;
      color: white;
      font-size: 16px;
      font-weight: 600;
      letter-spacing: 0.5px;
      cursor: pointer;
      transition: all 0.3s ease;
      box-shadow: 0 10px 20px rgba(0, 210, 255, 0.2);
      margin-top: 10px;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 10px;
    }

    #loginButton:hover {
      transform: translateY(-2px);
      box-shadow: 0 15px 30px rgba(0, 210, 255, 0.4);
      background: linear-gradient(135deg, #3a7bd5 0%, #00d2ff 100%);
    }

    .container {
      width: 100%;
      max-width: 600px;
      margin: 20px auto;
      padding: 30px;
      border-radius: 30px;
      box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.5);
      background: rgba(15, 15, 20, 0.6);
      backdrop-filter: blur(20px);
      border: 1px solid var(--glass-border);
      position: relative;
      animation: fadeIn 0.5s ease-out;
    }

    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(20px); }
      to { opacity: 1; transform: translateY(0); }
    }

    button {
      width: 100%;
      padding: 14px 20px;
      border: none;
      border-radius: 14px;
      font-size: 15px;
      font-weight: 500;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 10px;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      font-family: 'Poppins', sans-serif;
    }

    #dashboard h2 {
      font-size: 22px;
      color: #fff;
      font-weight: 600;
      margin-bottom: 25px;
      text-transform: uppercase;
      letter-spacing: 1px;
      text-align: center;
      background: linear-gradient(to right, #a1c4fd, #c2e9fb);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
    }

    .clock {
      font-family: 'Digital dream Fat', monospace;
      font-size: 3.2rem;
      font-weight: bold;
      color: #00f2ff;
      text-align: center;
      margin: 20px 0;
      text-shadow: 0 0 10px rgba(0, 242, 255, 0.5);
      letter-spacing: 2px;
    }

    .staff-info {
      background: linear-gradient(135deg, rgba(0, 210, 255, 0.1), rgba(58, 123, 213, 0.05));
      padding: 20px;
      border-radius: 20px;
      margin: 20px 0;
      border: 1px solid rgba(0, 210, 255, 0.2);
      text-align: center;
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
    }

    .staff-info p {
      margin: 10px 0;
      color: #e0e0e0;
      font-size: 16px;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 10px;
    }

    .staff-name {
      font-size: 20px !important;
      font-weight: 700 !important;
      color: #fff !important;
    }

    .role-display {
      font-size: 13px !important;
      background: rgba(255, 255, 255, 0.1);
      padding: 4px 12px;
      border-radius: 20px;
      color: var(--primary-glow) !important;
    }

    .status-panel {
      background: rgba(0, 0, 0, 0.3);
      border: 1px solid var(--glass-border);
      padding: 20px;
      border-radius: 20px;
      margin: 20px 0;
      text-align: center;
    }

    .time-btns {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 15px;
      margin-top: 25px;
    }

    .gradient-btn {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      box-shadow: 0 4px 15px rgba(118, 75, 162, 0.4);
    }

    .gradient-btn:hover:not(:disabled) {
      transform: translateY(-3px);
      box-shadow: 0 8px 25px rgba(118, 75, 162, 0.6);
    }

    .logout-btn {
      background: rgba(255, 71, 87, 0.1);
      color: #ff6b6b;
      border: 1px solid rgba(255, 71, 87, 0.3);
    }

    .logout-btn:hover:not(:disabled) {
      background: #ff4757;
      color: white;
    }

    .disabled-btn {
      opacity: 0.4 !important;
      cursor: not-allowed !important;
      background: #333 !important;
      color: #888 !important;
    }

    .warning-marquee {
      background: rgba(255, 71, 87, 0.1);
      border: 1px solid rgba(255, 71, 87, 0.3);
      color: #ff6b6b;
      padding: 12px;
      border-radius: 12px;
      margin: 20px 0;
      text-align: center;
      font-weight: 500;
    }

    .popup-notification {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background: #1a1a2e;
      color: #fff;
      padding: 25px 35px;
      border-radius: 20px;
      box-shadow: 0 25px 50px -12px rgba(0,0,0,0.5);
      z-index: 10001;
      display: none;
      text-align: center;
      border: 1px solid var(--glass-border);
      animation: popIn 0.3s forwards;
      width: 80%;
      max-width: 400px;
    }

    @keyframes popIn {
      from { transform: translate(-50%, -50%) scale(0.8); opacity: 0; }
      to { transform: translate(-50%, -50%) scale(1); opacity: 1; }
    }

    #popupOverlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.6);
      backdrop-filter: blur(4px);
      z-index: 10000;
      display: none;
      align-items: center;
      justify-content: center;
    }

    .hidden { display: none !important; }

    .loading-spinner {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.7);
      z-index: 10000;
      justify-content: center;
      align-items: center;
      flex-direction: column;
    }

    .spinner {
      width: 50px;
      height: 50px;
      border: 3px solid rgba(255,255,255,0.1);
      border-radius: 50%;
      border-top-color: var(--primary-glow);
      animation: spin 1s ease-in-out infinite;
    }

    @keyframes spin { to { transform: rotate(360deg); } }
  </style>
</head>
<body>

  <img id="backgroundImage" class="background-image" src="" alt="Background">

  <div id="loadingSpinner" class="loading-spinner">
    <div class="spinner"></div>
    <p id="loadingText">Loading...</p>
  </div>

  <div id="loginForm">
    <div class="login-logo-wrapper">
      <img src="https://cdn.corenexis.com/files/c/32466972.png" alt="Logo">
      <h2>Selamat Datang</h2>
      <p class="subtitle">Silahkan masuk ke akun anda</p>
    </div>

    <form onsubmit="event.preventDefault(); login();">
      <div class="modern-input-group">
        <i class="fas fa-user icon-left"></i>
        <input type="text" id="username" placeholder="Username" required autocomplete="off">
      </div>

      <div class="modern-input-group">
        <i class="fas fa-lock icon-left"></i>
        <input type="password" id="password" placeholder="Password" required>
        <i class="fas fa-eye toggle-password" id="togglePassword" onclick="togglePasswordVisibility()"></i>
      </div>

      <div id="error-message"></div>
      <div id="ipWhitelistMessage"></div>

      <button type="submit" id="loginButton">
        <span>MASUK SEKARANG</span>
        <i class="fas fa-arrow-right"></i>
      </button>
    </form>
  </div>

  <div id="dashboard" class="container hidden">
    <h2><i class="fas fa-clock"></i> IZIN STAFF LINETOGEL 2026</h2>
    <center><div id="MyClockDisplay" class="clock"></div></center>

    <div id="timeWarning" class="warning-marquee" style="display:none;">
      <i class="fas fa-exclamation-triangle"></i>
      <span id="warningText"></span>
    </div>

    <div class="staff-info">
      <p><i class="fas fa-user"></i> Staff: <span id="staffNameDisplay" class="staff-name"></span></p>
      <p><i class="fas fa-id-badge"></i> Role: <span id="userRoleDisplay" class="role-display"></span></p>
      <p><i class="fas fa-list-ol"></i> Limit Izin: <span id="limitDisplay" style="color: var(--warning); font-weight: 600;"></span></p>
    </div>

    <div class="time-btns">
      <button id="startTimeButton" class="gradient-btn"><i class="fas fa-door-open"></i> Izin Keluar</button>
      <button id="endTimeButton" class="gradient-btn"><i class="fas fa-sign-in-alt"></i> Kembali Masuk</button>
    </div>

    <div id="statusPanel" class="status-panel">
      <div id="statusPanelContent"></div>
    </div>

    <div style="margin-top: 20px;">
      <button class="logout-btn" id="logoutButton"><i class="fas fa-sign-out-alt"></i> Logout</button>
    </div>
  </div>

  <div id="popupOverlay">
    <div id="popupNotification">
      <p id="popupMessage"></p>
      <button onclick="hidePopup()" class="gradient-btn" style="margin-top: 20px;">
        <i class="fas fa-times"></i> Close
      </button>
    </div>
  </div>

  <script>
    const GOOGLE_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbzCrbbVEeEgEq8L0a4w8-SPJBoRQg7rDV9h6mOt4OQ82oeuoL6AgdSwE1DzwjhAdEc/exec';
    
    // Role-based concurrent session limits (bukan per hari, tapi bersamaan)
    const ROLE_SESSION_LIMITS = {
      'KS': 3,          // Max 3 browser/PC bersamaan
      'CS LINE': 2,     // Max 2 browser/PC bersamaan
      'KKS': 2,         // Max 2 browser/PC bersamaan
      'KHMER': 1        // Max 1 browser/PC (tidak bisa pakai 2 device bersamaan)
    };

    let currentUser = null;
    let currentIP = '';
    let deviceFingerprint = '';
    let maxConcurrentSessions = 1;

    function togglePasswordVisibility() {
      const passwordInput = document.getElementById("password");
      const toggleIcon = document.getElementById("togglePassword");
      if (passwordInput.type === "password") {
        passwordInput.type = "text";
        toggleIcon.classList.replace("fa-eye", "fa-eye-slash");
      } else {
        passwordInput.type = "password";
        toggleIcon.classList.replace("fa-eye-slash", "fa-eye");
      }
    }

    function getFormattedDate(date) {
      return date.toISOString().split('T')[0];
    }

    function getFormattedTime(date) {
      return date.toTimeString().split(' ')[0];
    }

    function showLoading(message = 'Loading...') {
      document.getElementById('loadingText').textContent = message;
      document.getElementById('loadingSpinner').style.display = 'flex';
    }

    function hideLoading() {
      document.getElementById('loadingSpinner').style.display = 'none';
    }

    function showError(message) {
      const errorEl = document.getElementById('error-message');
      errorEl.innerHTML = `<i class="fas fa-exclamation-circle"></i> ${message}`;
      errorEl.style.display = 'block';
    }

    function showPopup(message, duration = 5000) {
      document.getElementById('popupMessage').innerHTML = message;
      document.getElementById('popupOverlay').style.display = 'flex';
      if (duration > 0) {
        setTimeout(() => hidePopup(), duration);
      }
    }

    function hidePopup() {
      document.getElementById('popupOverlay').style.display = 'none';
    }

    function updateClock() {
      const now = new Date();
      const time = now.toTimeString().split(' ')[0];
      document.getElementById('MyClockDisplay').textContent = time;
    }

    function getRoleLimit(role) {
      const roleUpper = (role || '').toUpperCase().trim();
      for (const [key, limit] of Object.entries(ROLE_LIMITS)) {
        if (roleUpper.includes(key.toUpperCase())) {
          return limit;
        }
      }
      return 4; // Default limit
    }

    async function checkStartTimeLimit() {
      try {
        const response = await fetch(`${GOOGLE_SCRIPT_URL}?action=checkStartTimeLimit&username=${encodeURIComponent(currentUser.username)}`);
        const data = await response.json();
        
        // Get role-specific limit
        const roleLimit = getRoleLimit(currentUser.role);
        maxStartLimit = roleLimit;
        
        return {
          ...data,
          maxCount: roleLimit,
          remaining: roleLimit - (data.count || 0)
        };
      } catch (error) {
        console.error('Error checking limit:', error);
        return { success: false, canStart: true };
      }
    }

    function updateUI(limitData) {
      const remaining = limitData.remaining || 0;
      const count = limitData.count || 0;
      const maxCount = limitData.maxCount || maxStartLimit;

      document.getElementById('limitDisplay').textContent = `${count}/${maxCount} (Sisa: ${remaining})`;
      
      const startBtn = document.getElementById('startTimeButton');
      const statusPanel = document.getElementById('statusPanelContent');

      if (count >= maxCount) {
        startBtn.disabled = true;
        startBtn.classList.add('disabled-btn');
        startBtn.innerHTML = '<i class="fas fa-ban"></i> Limit Tercapai';
        statusPanel.innerHTML = `<p style="color: var(--danger); font-weight: 600;">⛔ Anda sudah mencapai limit izin keluar hari ini (${maxCount}x)</p>`;
      } else {
        startBtn.disabled = false;
        startBtn.classList.remove('disabled-btn');
        startBtn.innerHTML = '<i class="fas fa-door-open"></i> Izin Keluar';
        statusPanel.innerHTML = `<p style="color: var(--success);">✅ Anda masih bisa izin keluar ${remaining}x lagi hari ini</p>`;
      }
    }

    async function startTime() {
      const limitCheck = await checkStartTimeLimit();
      
      if (!limitCheck.canStart || limitCheck.count >= maxStartLimit) {
        showPopup(`<div style="color:#ff4757;text-align:center;"><i class="fas fa-ban fa-2x"></i><br><strong>LIMIT TERCAPAI!</strong><br>Anda sudah mencapai batas maksimal ${maxStartLimit}x izin keluar hari ini</div>`, 5000);
        updateUI(limitCheck);
        return;
      }

      try {
        const now = new Date();
        const attendanceData = {
          tanggal: getFormattedDate(now),
          hari: now.toLocaleDateString('id-ID', { weekday: 'long' }),
          username: currentUser.username,
          nama: currentUser.name,
          status: currentUser.role,
          waktu_mulai: getFormattedTime(now),
          waktu_selesai: '',
          jobdesk: '',
          ip_address: currentIP,
          attendance_status: 'Active',
          session_id: now.getTime().toString()
        };

        const records = JSON.parse(localStorage.getItem('attendanceRecords') || '[]');
        records.push(attendanceData);
        localStorage.setItem('attendanceRecords', JSON.stringify(records));

        showPopup(`<div style="color:#2ed573;text-align:center;"><i class="fas fa-check-circle fa-2x"></i><br><strong>Izin Keluar Berhasil!</strong></div>`, 3000);

        // Update UI after starting
        setTimeout(async () => {
          const newLimitData = await checkStartTimeLimit();
          updateUI(newLimitData);
        }, 500);

        // Send to server in background
        const formData = new FormData();
        formData.append('action', 'insert');
        formData.append('sheetName', 'DATABASE LINETOGEL');
        formData.append('data', JSON.stringify(attendanceData));
        fetch(GOOGLE_SCRIPT_URL, { method: 'POST', body: formData });

      } catch (error) {
        console.error('Error:', error);
        showPopup(`<div style="color:#ff4757;">Error: ${error.message}</div>`, 5000);
      }
    }

    async function endTime() {
      const records = JSON.parse(localStorage.getItem('attendanceRecords') || '[]');
      const today = getFormattedDate(new Date());
      const activeIndex = records.findIndex(r => 
        r.tanggal === today && 
        r.username === currentUser.username && 
        r.attendance_status === 'Active'
      );

      if (activeIndex === -1) {
        showPopup(`<div style="color:#ffa502;">Tidak ada sesi aktif!</div>`, 3000);
        return;
      }

      records[activeIndex].waktu_selesai = getFormattedTime(new Date());
      records[activeIndex].attendance_status = 'Completed';
      localStorage.setItem('attendanceRecords', JSON.stringify(records));

      showPopup(`<div style="color:#2ed573;text-align:center;"><i class="fas fa-check-circle fa-2x"></i><br><strong>Kembali Masuk Berhasil!</strong></div>`, 3000);

      // Update server
      const formData = new FormData();
      formData.append('action', 'update');
      formData.append('sheetName', 'DATABASE LINETOGEL');
      formData.append('data', JSON.stringify(records[activeIndex]));
      fetch(GOOGLE_SCRIPT_URL, { method: 'POST', body: formData });
    }

    async function login() {
      const username = document.getElementById('username').value.trim();
      const password = document.getElementById('password').value.trim();

      if (!username || !password) {
        showError('Masukkan username dan password!');
        return;
      }

      showLoading('Logging in...');

      try {
        // Simulate user lookup - replace with your actual API call
        currentUser = {
          username: username,
          password: password,
          name: username,
          role: 'KS' // This should come from your API
        };

        localStorage.setItem('currentUser', JSON.stringify(currentUser));

        document.getElementById('loginForm').style.display = 'none';
        document.getElementById('dashboard').classList.remove('hidden');

        document.getElementById('staffNameDisplay').textContent = currentUser.name;
        document.getElementById('userRoleDisplay').textContent = currentUser.role;

        const limitData = await checkStartTimeLimit();
        updateUI(limitData);

      } catch (error) {
        showError('Login gagal: ' + error.message);
      } finally {
        hideLoading();
      }
    }

    function logout() {
      localStorage.clear();
      location.reload();
    }

    // Event listeners
    document.getElementById('startTimeButton').addEventListener('click', startTime);
    document.getElementById('endTimeButton').addEventListener('click', endTime);
    document.getElementById('logoutButton').addEventListener('click', logout);

    // Initialize
    setInterval(updateClock, 1000);
    updateClock();

    // Check saved session
    const savedUser = localStorage.getItem('currentUser');
    if (savedUser) {
      currentUser = JSON.parse(savedUser);
      document.getElementById('loginForm').style.display = 'none';
      document.getElementById('dashboard').classList.remove('hidden');
      document.getElementById('staffNameDisplay').textContent = currentUser.name;
      document.getElementById('userRoleDisplay').textContent = currentUser.role;
      checkStartTimeLimit().then(updateUI);
    }
  </script>
</body>
</html>
