<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Izin Keluar Linetgl</title>

  <!-- FAVICON BARU -->
  <link rel="shortcut icon" href="https://cdn-icons-png.flaticon.com/512/190/190411.png" type="image/x-icon">

  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css" rel="stylesheet">
  <!-- Bootstrap CSS for modal -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">

  <!-- Google Fonts for Modern Look -->
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700&display=swap" rel="stylesheet">

  <style>
    /* ============================================
       MODERN DESIGN STYLES (CSS BARU)
    ============================================ */
    :root {
      --bg-gradient: linear-gradient(135deg, #0f0c29, #302b63, #24243e);
      --glass-bg: rgba(255, 255, 255, 0.05);
      --glass-border: rgba(255, 255, 255, 0.1);
      --primary-glow: #00d2ff;
      --secondary-glow: #3a7bd5;
      --text-main: #ffffff;
      --text-muted: rgba(255, 255, 255, 0.6);
      --danger: #ff4757;
      --success: #2ed573;
      --warning: #ffa502;
    }

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Poppins', sans-serif;
      background: var(--bg-gradient);
      background-size: 400% 400%;
      animation: gradientBG 15s ease infinite;
      margin: 0;
      display: flex;
      justify-content: center;
      align-items: center;
      min-height: 100vh;
      overflow-x: hidden;
      color: var(--text-main);
    }

    @keyframes gradientBG {
      0% { background-position: 0% 50%; }
      50% { background-position: 100% 50%; }
      100% { background-position: 0% 50%; }
    }

    /* Background Image Logic */
    .background-image {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      object-fit: cover;
      z-index: -2;
      opacity: 0;
      transition: opacity 1.5s ease-in-out;
    }

    .background-image.active {
      opacity: 0.2;
      filter: blur(5px);
    }

    /* ============================================
       MODERN LOGIN DESIGN
    ============================================ */
    #loginForm {
      position: relative;
      width: 100%;
      max-width: 420px;
      padding: 40px;
      background: var(--glass-bg);
      backdrop-filter: blur(20px);
      -webkit-backdrop-filter: blur(20px);
      border: 1px solid var(--glass-border);
      border-radius: 30px;
      box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.5);
      animation: slideUpFade 0.8s cubic-bezier(0.2, 0.8, 0.2, 1) forwards;
      margin: 20px;
    }

    @keyframes slideUpFade {
      0% { opacity: 0; transform: translateY(30px) scale(0.95); }
      100% { opacity: 1; transform: translateY(0) scale(1); }
    }

    /* Logo Area */
    #loginForm .login-logo-wrapper {
      text-align: center;
      margin-bottom: 35px;
    }

    #loginForm .login-logo-wrapper img {
      width: 90px;
      height: auto;
      margin-bottom: 15px;
      filter: drop-shadow(0 0 15px rgba(0, 210, 255, 0.4));
    }

    #loginForm h2 {
      text-align: center;
      color: #ffffff;
      font-weight: 700;
      font-size: 26px;
      letter-spacing: 1px;
      margin: 0 0 8px 0;
      background: linear-gradient(to right, #fff, #a1c4fd);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
    }

    #loginForm .subtitle {
      text-align: center;
      color: var(--text-muted);
      font-size: 14px;
      margin-bottom: 35px;
      font-weight: 300;
    }

    /* Modern Inputs */
    .modern-input-group {
      position: relative;
      margin-bottom: 25px;
    }

    .modern-input-group i.icon-left {
      position: absolute;
      left: 18px;
      top: 50%;
      transform: translateY(-50%);
      color: var(--text-muted);
      font-size: 16px;
      transition: all 0.3s ease;
    }

    .modern-input-group input {
      width: 100%;
      background: rgba(0, 0, 0, 0.3);
      border: 1px solid var(--glass-border);
      padding: 16px 50px 16px 50px; 
      border-radius: 16px;
      color: #fff;
      font-size: 15px;
      font-family: 'Poppins', sans-serif;
      box-sizing: border-box;
      transition: all 0.3s ease;
    }

    .modern-input-group input::placeholder {
      color: rgba(255, 255, 255, 0.3);
    }

    .modern-input-group input:focus {
      outline: none;
      background: rgba(0, 0, 0, 0.5);
      border-color: var(--primary-glow);
      box-shadow: 0 0 20px rgba(0, 210, 255, 0.15);
    }

    .modern-input-group input:focus + i.icon-left {
      color: var(--primary-glow);
      text-shadow: 0 0 10px var(--primary-glow);
    }

    /* Password Toggle Generic */
    .modern-input-group i.toggle-password, .modern-input-group i.toggle-pwd-icon {
      position: absolute;
      right: 18px;
      top: 50%;
      transform: translateY(-50%);
      color: var(--text-muted);
      cursor: pointer;
      font-size: 16px;
      transition: color 0.3s;
    }

    .modern-input-group i.toggle-password:hover, .modern-input-group i.toggle-pwd-icon:hover {
      color: #fff;
    }

    /* Error & IP Message */
    #error-message, #ipWhitelistMessage {
      font-size: 13px;
      text-align: center;
      margin-top: -15px;
      margin-bottom: 20px;
      padding: 10px;
      border-radius: 10px;
      display: none;
    }

    #error-message {
      color: #ff6b6b;
      background: rgba(255, 71, 87, 0.1);
      border: 1px solid rgba(255, 71, 87, 0.2);
    }

    #ipWhitelistMessage {
      color: #ffd32a;
      background: rgba(255, 211, 42, 0.1);
      border: 1px solid rgba(255, 211, 42, 0.2);
    }

    /* Modern Login Button */
    #loginButton {
      width: 100%;
      padding: 16px;
      background: linear-gradient(135deg, #00d2ff 0%, #3a7bd5 100%);
      border: none;
      border-radius: 16px;
      color: white;
      font-size: 16px;
      font-weight: 600;
      letter-spacing: 0.5px;
      cursor: pointer;
      transition: all 0.3s ease;
      box-shadow: 0 10px 20px rgba(0, 210, 255, 0.2);
      margin-top: 10px;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 10px;
    }

    #loginButton:hover {
      transform: translateY(-2px);
      box-shadow: 0 15px 30px rgba(0, 210, 255, 0.4);
      background: linear-gradient(135deg, #3a7bd5 0%, #00d2ff 100%);
    }

    #loginButton:active {
      transform: translateY(1px);
    }

    /* ============================================
       DASHBOARD CONTAINERS
    ============================================ */
    .container {
      width: 100%;
      max-width: 600px;
      margin: 20px auto;
      padding: 30px;
      border-radius: 30px;
      box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.5);
      background: rgba(15, 15, 20, 0.6);
      backdrop-filter: blur(20px);
      -webkit-backdrop-filter: blur(20px);
      border: 1px solid var(--glass-border);
      position: relative;
      animation: fadeIn 0.5s ease-out;
    }

    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(20px); }
      to { opacity: 1; transform: translateY(0); }
    }

    /* Account Actions Container */
    .account-actions-container {
      margin-top: 25px;
      padding: 20px;
      background: rgba(255, 255, 255, 0.03);
      border-radius: 20px;
      border: 1px solid var(--glass-border);
    }

    /* Buttons General Style */
    button {
      width: 100%;
      padding: 14px 20px;
      border: none;
      border-radius: 14px;
      font-size: 15px;
      font-weight: 500;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 10px;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      font-family: 'Poppins', sans-serif;
    }

    /* Dashboard Header */
    #dashboard h2 {
      font-size: 22px;
      color: #fff;
      font-weight: 600;
      margin-bottom: 25px;
      text-transform: uppercase;
      letter-spacing: 1px;
      text-align: center;
      background: linear-gradient(to right, #a1c4fd, #c2e9fb);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
    }

    #dashboard img.logo {
      width: 80px;
      margin-bottom: 15px;
      filter: drop-shadow(0 0 10px rgba(255,255,255,0.3));
    }

    /* Clock */
    .clock {
      font-family: 'Digital dream Fat', monospace;
      font-size: 3.2rem;
      font-weight: bold;
      color: #00f2ff;
      text-align: center;
      margin: 20px 0;
      text-shadow: 0 0 10px rgba(0, 242, 255, 0.5), 0 0 20px rgba(0, 242, 255, 0.3);
      letter-spacing: 2px;
    }

    /* Fancy HR */
    .fancy-hr {
      border: 0;
      height: 1px;
      background: linear-gradient(to right, transparent, rgba(255,255,255,0.2), transparent);
      margin: 25px 0;
    }

    /* Staff Info Card */
    .staff-info {
      background: linear-gradient(135deg, rgba(0, 210, 255, 0.1), rgba(58, 123, 213, 0.05));
      padding: 20px;
      border-radius: 20px;
      margin: 20px 0;
      border: 1px solid rgba(0, 210, 255, 0.2);
      text-align: center;
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
    }

    .staff-info p {
      margin: 10px 0;
      color: #e0e0e0;
      font-size: 16px;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 10px;
    }

    .staff-info i {
      color: var(--primary-glow);
      width: 20px;
    }

    .staff-name {
      font-size: 20px !important;
      font-weight: 700 !important;
      color: #fff !important;
      text-shadow: 0 0 10px rgba(255,255,255,0.3);
    }

    .role-display {
      font-size: 13px !important;
      background: rgba(255, 255, 255, 0.1);
      padding: 4px 12px;
      border-radius: 20px;
      border: 1px solid rgba(255, 255, 255, 0.1);
      color: var(--primary-glow) !important;
    }

    /* Status Panel */
    .status-panel {
      background: rgba(0, 0, 0, 0.3);
      border: 1px solid var(--glass-border);
      padding: 20px;
      border-radius: 20px;
      margin: 20px 0;
      text-align: center;
      position: relative;
      overflow: hidden;
      transition: all 0.3s ease;
    }

    .status-panel.active {
      border-color: var(--success);
      box-shadow: 0 0 20px rgba(46, 213, 115, 0.15);
      background: linear-gradient(135deg, rgba(46, 213, 115, 0.05), rgba(0, 0, 0, 0.3));
    }

    .status-title {
      font-size: 16px;
      font-weight: 600;
      margin-bottom: 10px;
      color: var(--text-muted);
      text-transform: uppercase;
      letter-spacing: 1px;
    }

    .status-time {
      font-size: 24px;
      font-weight: 700;
      color: #fff;
      margin: 5px 0;
      text-shadow: 0 0 15px rgba(255,255,255,0.2);
    }

    .status-duration {
      font-size: 15px;
      color: var(--warning);
      display: inline-flex;
      align-items: center;
      gap: 6px;
      background: rgba(255, 165, 2, 0.1);
      padding: 5px 12px;
      border-radius: 50px;
      border: 1px solid rgba(255, 165, 2, 0.2);
    }

    /* Jobdesk Select */
    #jobdeskSection {
      margin-top: 20px;
    }

    #jobdeskSection select {
      width: 100%;
      padding: 14px 20px;
      border-radius: 16px;
      border: 1px solid var(--glass-border);
      background: rgba(0, 0, 0, 0.3);
      color: white;
      font-size: 15px;
      appearance: none;
      background-image: url("data:image/svg+xml;charset=UTF-8,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='white' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3e%3cpolyline points='6 9 12 15 18 9'%3e%3c/polyline%3e%3c/svg%3e");
      background-repeat: no-repeat;
      background-position: right 1rem center;
      background-size: 1em;
      cursor: pointer;
      transition: border-color 0.3s;
    }

    #jobdeskSection select:focus {
      outline: none;
      border-color: var(--primary-glow);
    }

    /* Action Buttons Layout */
    .time-btns {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 15px;
      margin-top: 25px;
    }

    .account-actions {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 15px;
      margin-top: 15px;
    }

    /* Specific Button Colors */
    .gradient-btn {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      box-shadow: 0 4px 15px rgba(118, 75, 162, 0.4);
      border: 1px solid rgba(255,255,255,0.1);
    }

    .gradient-btn:hover:not(:disabled) {
      transform: translateY(-3px);
      box-shadow: 0 8px 25px rgba(118, 75, 162, 0.6);
    }

    .logout-btn {
      background: rgba(255, 71, 87, 0.1);
      color: #ff6b6b;
      border: 1px solid rgba(255, 71, 87, 0.3);
    }

    .logout-btn:hover:not(:disabled) {
      background: #ff4757;
      color: white;
      box-shadow: 0 5px 15px rgba(255, 71, 87, 0.4);
    }

    .change-password-btn {
      background: rgba(0, 210, 255, 0.1);
      color: #00d2ff;
      border: 1px solid rgba(0, 210, 255, 0.3);
    }

    .change-password-btn:hover:not(:disabled) {
      background: #00d2ff;
      color: white;
      box-shadow: 0 5px 15px rgba(0, 210, 255, 0.4);
    }

    /* Disabled State */
    .disabled-btn {
      opacity: 0.4 !important;
      cursor: not-allowed !important;
      transform: none !important;
      box-shadow: none !important;
      background: #333 !important;
      color: #888 !important;
    }

    /* Modals */
    .custom-modal, .password-modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0, 0, 0, 0.8);
      backdrop-filter: blur(8px);
      z-index: 9999;
      justify-content: center;
      align-items: center;
    }

    .custom-modal-content, .password-modal-content {
      background: #1a1a2e;
      padding: 40px;
      border-radius: 24px;
      max-width: 400px;
      width: 90%;
      text-align: center;
      border: 1px solid var(--glass-border);
      box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.7);
      animation: popIn 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
    }

    @keyframes popIn {
      from { transform: scale(0.8); opacity: 0; }
      to { transform: scale(1); opacity: 1; }
    }

    .custom-modal-title, .password-modal-title {
      font-size: 24px;
      margin-bottom: 15px;
      color: #fff;
    }

    .custom-modal-message, .password-message {
      font-size: 16px;
      margin-bottom: 25px;
      color: #ccc;
      line-height: 1.6;
    }

    /* Warning Marquee & Alerts */
    .warning-marquee {
      background: rgba(255, 71, 87, 0.1);
      border: 1px solid rgba(255, 71, 87, 0.3);
      color: #ff6b6b;
      padding: 12px;
      border-radius: 12px;
      margin: 20px 0;
      overflow: hidden;
      white-space: nowrap;
      font-weight: 500;
    }

    .danger-alert {
      background: rgba(255, 71, 87, 0.15);
      border: 1px solid rgba(255, 71, 87, 0.4);
      color: #ff4757;
      padding: 20px;
      border-radius: 16px;
      text-align: center;
      margin-bottom: 20px;
    }

    /* Blocked Dashboard */
    .blocked-dashboard {
      text-align: center;
      padding: 40px 20px;
      background: rgba(255, 71, 87, 0.05);
      border: 2px solid rgba(255, 71, 87, 0.3);
      border-radius: 24px;
    }

    .blocked-icon {
      font-size: 50px;
      color: #ff4757;
      margin-bottom: 20px;
      animation: shake 3s infinite;
    }

    @keyframes shake {
      0%, 100% { transform: translateX(0); }
      10%, 30%, 50%, 70%, 90% { transform: translateX(-5px); }
      20%, 40%, 60%, 80% { transform: translateX(5px); }
    }

    /* Status Indicators */
    .connection-status, .ip-display, .realtime-indicator, .update-notification, .debug-info {
      position: fixed;
      padding: 8px 15px;
      border-radius: 50px;
      font-size: 12px;
      z-index: 1000;
      backdrop-filter: blur(10px);
      border: 1px solid rgba(255,255,255,0.1);
    }

    .connection-status {
      top: 20px;
      right: 20px;
      background: rgba(0,0,0,0.6);
      color: white;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .ip-display {
      bottom: 20px;
      right: 20px;
      background: rgba(0,0,0,0.6);
      color: #ccc;
    }

    .realtime-indicator {
      top: 20px;
      left: 20px;
      background: rgba(46, 213, 115, 0.1);
      color: #2ed573;
      border-color: rgba(46, 213, 115, 0.3);
      display: none;
      align-items: center;
      gap: 8px;
    }

    .update-notification {
      bottom: 80px;
      right: 20px;
      background: rgba(0, 210, 255, 0.15);
      color: #00d2ff;
      border-color: rgba(0, 210, 255, 0.3);
      display: none;
      align-items: center;
      gap: 8px;
      box-shadow: 0 5px 15px rgba(0,0,0,0.2);
    }

    .status-indicator {
      width: 8px;
      height: 8px;
      border-radius: 50%;
    }

    .status-connected { background: #2ed573; box-shadow: 0 0 10px #2ed573; }
    .status-disconnected { background: #ff4757; box-shadow: 0 0 10px #ff4757; }

    /* Spinner */
    .loading-spinner {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.7);
      backdrop-filter: blur(5px);
      z-index: 10000;
      justify-content: center;
      align-items: center;
      flex-direction: column;
    }

    .spinner {
      width: 50px;
      height: 50px;
      border: 3px solid rgba(255,255,255,0.1);
      border-radius: 50%;
      border-top-color: var(--primary-glow);
      animation: spin 1s ease-in-out infinite;
    }

    @keyframes spin { to { transform: rotate(360deg); } }

    .loading-spinner p { margin-top: 15px; color: white; font-weight: 500; }

    /* Popups */
    .popup-notification {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background: #1a1a2e;
      color: #fff;
      padding: 25px 35px;
      border-radius: 20px;
      box-shadow: 0 25px 50px -12px rgba(0,0,0,0.5);
      z-index: 10001;
      display: none;
      text-align: center;
      border: 1px solid var(--glass-border);
      animation: popIn 0.3s forwards;
      width: 80%;
      max-width: 400px;
    }

    #popupOverlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.6);
      backdrop-filter: blur(4px);
      z-index: 10000;
      display: none;
      align-items: center;
      justify-content: center;
    }

    #popupNotification {
      background: rgba(20, 20, 30, 0.95);
      padding: 30px;
      border-radius: 24px;
      text-align: center;
      border: 1px solid var(--glass-border);
      box-shadow: 0 20px 50px rgba(0,0,0,0.5);
      max-width: 90%;
      width: 400px;
    }

    /* Password Modal Specifics */
    .password-form-group { margin-bottom: 20px; text-align: left; }
    .password-form-group label { display: block; margin-bottom: 8px; color: #ccc; font-size: 13px; font-weight: 500; }

    /* Reuse modern-input-group for modal inputs for consistency */
    .password-form-group .modern-input-group { margin-bottom: 0; }
    .password-form-group input {
      width: 100%;
      padding: 12px 50px 12px 45px;
      background: rgba(0,0,0,0.3);
      border: 1px solid var(--glass-border);
      border-radius: 12px;
      color: white;
      box-sizing: border-box;
      transition: 0.3s;
    }
    .password-form-group input:focus { border-color: var(--primary-glow); outline: none; }

    /* Icon left positioning for modal inputs */
    .password-form-group .modal-icon-left {
      position: absolute;
      left: 15px;
      top: 50%;
      transform: translateY(-50%);
      color: var(--text-muted);
    }

    .password-message { padding: 10px; border-radius: 10px; font-size: 14px; margin-bottom: 15px; display: none; }
    .password-message.success { background: rgba(46, 213, 115, 0.1); color: #2ed573; border: 1px solid rgba(46, 213, 115, 0.2); }
    .password-message.error { background: rgba(255, 71, 87, 0.1); color: #ff4757; border: 1px solid rgba(255, 71, 87, 0.2); }

    .password-modal-buttons { display: flex; gap: 10px; margin-top: 10px; }
    .password-save-btn { background: linear-gradient(135deg, #00d2ff, #3a7bd5); color: white; border: none; }
    .password-cancel-btn { background: rgba(255, 255, 255, 0.1); color: white; border: 1px solid rgba(255,255,255,0.1); }

    /* Utility Classes */
    .hidden {
      display: none !important;
    }

    /* Font Face for Clock */
    @font-face {
      font-family: 'Digital dream Fat';
      src: url('https://semicon.github.io/fonts/DigitaldreamFat.woff2') format('woff2'),
        url('https://semicon.github.io/fonts/DigitaldreamFat.woff') format('woff');
      font-weight: normal;
      font-style: normal;
      font-display: swap;
    }

    /* Responsive */
    @media (max-width: 768px) {
      .container { padding: 20px; margin: 10px; }
      .time-btns, .account-actions { grid-template-columns: 1fr; }
      .clock { font-size: 2.5rem; }
      #loginForm { padding: 30px 20px; }
      .connection-status, .ip-display, .realtime-indicator, .update-notification {
        font-size: 10px;
        padding: 6px 10px;
      }
    }
  </style>
</head>

<body>

  <!-- Background Image -->
  <img id="backgroundImage" class="background-image" src="" alt="Background">

  <!-- Loading Spinner Notification -->
  <div id="loadingSpinner" class="loading-spinner">
    <div class="spinner"></div>
    <p id="loadingText">Loading...</p>
  </div>

  <!-- Connection Status -->
  <div class="connection-status">
    <span class="status-indicator" id="statusIndicator"></span>
    <span id="statusText">Connecting...</span>
  </div>

  <!-- Real-time Update Indicator -->
  <div class="realtime-indicator" id="realtimeIndicator">
    <i class="fas fa-wifi" style="font-size: 10px;"></i>
    <span>Live Update Active</span>
  </div>

  <!-- Update Notification -->
  <div class="update-notification" id="updateNotification">
    <i class="fas fa-sync-alt"></i>
    <span id="updateMessage">Data Updated</span>
  </div>

  <!-- IP Display -->
  <div class="ip-display" id="ipDisplay">
    IP: <span id="currentIPText">Getting IP...</span>
  </div>

  <!-- Custom Modal for Max Limit Warning -->
  <div id="maxLimitModal" class="custom-modal">
    <div class="custom-modal-content">
      <div style="font-size: 50px; color: #ff4757; margin-bottom: 20px;">
        <i class="fas fa-ban"></i>
      </div>
      <h3 class="custom-modal-title">⛔ BATAS IZIN TELAH HABIS!</h3>
      <p class="custom-modal-message" id="maxLimitMessage">
        Anda sudah mencapai batas maksimal izin keluar hari ini.<br>
        Silakan lanjut besok!
      </p>
      <button class="gradient-btn" onclick="closeMaxLimitModal()">
        <i class="fas fa-times"></i> Tutup
      </button>
    </div>
  </div>

  <!-- Password Change Modal -->
  <div id="passwordChangeModal" class="password-modal">
    <div class="password-modal-content">
      <div class="password-modal-title">
        <i class="fas fa-key" style="margin-right: 10px; color: var(--primary-glow);"></i>
        <span>Ganti Password</span>
      </div>

      <div id="passwordMessage" class="password-message"></div>

      <div class="password-form-group">
        <label for="modalOldPassword">Password Lama:</label>
        <div class="modern-input-group">
          <i class="fas fa-lock modal-icon-left"></i>
          <input type="password" id="modalOldPassword" placeholder="Masukkan password lama" required>
          <i class="fas fa-eye toggle-pwd-icon" id="toggleOldPassword" onclick="toggleModalPassword('modalOldPassword', 'toggleOldPassword')"></i>
        </div>
      </div>

      <div class="password-form-group">
        <label for="modalNewPassword">Password Baru:</label>
        <div class="modern-input-group">
          <i class="fas fa-key modal-icon-left"></i>
          <input type="password" id="modalNewPassword" placeholder="Masukkan password baru" required>
          <i class="fas fa-eye toggle-pwd-icon" id="toggleNewPassword" onclick="toggleModalPassword('modalNewPassword', 'toggleNewPassword')"></i>
        </div>
      </div>

      <div class="password-form-group">
        <label for="modalConfirmPassword">Konfirmasi Password Baru:</label>
        <div class="modern-input-group">
          <i class="fas fa-check-circle modal-icon-left"></i>
          <input type="password" id="modalConfirmPassword" placeholder="Konfirmasi password baru" required>
          <i class="fas fa-eye toggle-pwd-icon" id="toggleConfirmPassword" onclick="toggleModalPassword('modalConfirmPassword', 'toggleConfirmPassword')"></i>
        </div>
      </div>

      <div class="password-modal-buttons">
        <button class="password-save-btn" id="modalSavePasswordBtn">
          <i class="fas fa-save"></i> Simpan
        </button>
        <button class="password-cancel-btn" id="modalCancelPasswordBtn">
          <i class="fas fa-times"></i> Batal
        </button>
      </div>
    </div>
  </div>

  <!-- ============================================
       NEW LOGIN FORM DESIGN
  ============================================ -->
  <div id="loginForm">
    <div class="login-logo-wrapper">
      <img src="https://cdn.corenexis.com/files/c/32466972.png" alt="Logo">
      <h2>Selamat Datang</h2>
      <p class="subtitle">Silahkan masuk ke akun anda</p>
    </div>

    <form id="loginFormForm" onsubmit="event.preventDefault(); login();">

      <!-- Username Input -->
      <div class="modern-input-group">
        <i class="fas fa-user icon-left"></i>
        <input type="text" id="username" placeholder="Username" required autocomplete="off">
      </div>

      <!-- Password Input with Eye Icon -->
      <div class="modern-input-group">
        <i class="fas fa-lock icon-left"></i>
        <input type="password" id="password" placeholder="Password" required autocomplete="current-password">
        <i class="fas fa-eye toggle-password" id="togglePassword" onclick="togglePasswordVisibility()"></i>
      </div>

      <!-- Error Message -->
      <div id="error-message"></div>

      <!-- IP Whitelist Message -->
      <div id="ipWhitelistMessage"></div>

      <!-- Login Button -->
      <button type="submit" id="loginButton">
        <span>MASUK SEKARANG</span>
        <i class="fas fa-arrow-right"></i>
      </button>

    </form>

    <div style="text-align: center; margin-top: 25px; color: rgba(255,255,255,0.2); font-size: 11px; letter-spacing: 0.5px;">
      &copy; 2026 Staff Linetogel
    </div>
  </div>
  <!-- ============================================ -->

  <!-- Dashboard -->
  <div id="dashboard" class="container hidden">
    <center><img src="https://cdn.areabermain.club/assets/cdn/az4/2025/04/23/20250423/a82bdc6fb564d0dff3671aeb9a4d1da5/logo.png" alt="Logo" class="logo"></center>
    <h2><i class="fas fa-clock"></i>IZIN STAFF LINETOGEL 2026 </h2>
    <center>
      <div id="MyClockDisplay" class="clock"></div>
    </center>
    <hr class="fancy-hr">

    <!-- Warning Marquee -->
    <div id="timeWarning" class="warning-marquee">
      <i class="fas fa-exclamation-triangle"></i> 
      <span id="warningText" style="margin-left: 10px;"></span>
    </div>

    <!-- Danger Alert for Max Limit -->
    <div id="maxLimitAlert" class="danger-alert" style="display: none;">
      <i class="fas fa-ban fa-2x"></i>
      <h4 style="margin-top: 15px;">⛔ BATAS IZIN TELAH HABIS!</h4>
      <p id="maxLimitAlertMessage"></p>
    </div>

    <!-- Blocked Dashboard View (shown when limit reached) -->
    <div id="blockedDashboard" class="blocked-dashboard" style="display: none;">
      <div class="blocked-icon">
        <i class="fas fa-ban"></i>
      </div>
      <h3 class="blocked-title">⛔ BATAS IZIN TELAH HABIS</h3>
      <p class="blocked-message" id="blockedMessage">
        Anda telah mencapai batas maksimal izin keluar hari ini.<br>
        Semua fitur telah dinonaktifkan.<br>
        Silakan lanjut besok!
      </p>
      <div class="account-actions">
        <button class="logout-btn" id="logoutButtonBlocked"><i class="fas fa-sign-out-alt"></i> Logout</button>
      </div>
    </div>

    <!-- Normal Dashboard View (shown when not blocked) -->
    <div id="normalDashboard">
      <!-- Hanya tampilkan nama staff dan role saja -->
      <div class="staff-info">
        <p><i class="fas fa-user"></i> Staff Name: <span id="staffNameDisplay" class="staff-name"></span></p>
        <p><i class="fas fa-id-badge"></i> Role: <span id="userRoleDisplay" class="role-display"></span></p>
        <p><i class="fas fa-chart-line"></i> Batas Izin: <span id="limitInfoDisplay" class="role-display" style="background: rgba(255,165,2,0.1);"></span></p>
      </div>

      <div id="jobdeskSection" class="hidden">
        <label for="jobdesk" style="display:block; margin-bottom: 8px; color: #ccc;">Pilih Jobdesk</label>
        <select id="jobdesk">
          <option value="">-- Silahkan Pilih --</option>
        </select>
        <div id="jobdeskError" style="color: #ff6b6b; display: none; margin-top: 8px; font-size: 13px; text-align: center;">Silahkan Pilih Jobdesk Anda</div>
      </div>

      <div class="time-btns">
        <button id="startTimeButton" class="gradient-btn"><i class="fas fa-door-open"></i> Izin Keluar</button>
        <button id="endTimeButton" class="gradient-btn"><i class="fas fa-sign-in-alt"></i> Kembali Masuk</button>
      </div>

      <!-- Status Panel -->
      <div id="statusPanel" class="status-panel">
        <div class="status-title">
          <i class="fas fa-user-clock" id="statusPanelIcon"></i>
          <span id="statusPanelTitle">Status Izin</span>
        </div>
        <div id="statusPanelContent">
          <div id="statusPanelTime"></div>
          <div id="statusPanelDuration"></div>
          <div id="statusPanelInfo" style="margin-top: 10px; font-size: 14px; color: #aaa;"></div>
        </div>
      </div>

      <div style="text-align: center; margin-top: 30px;">
        <a href="https://linetogel-izin.vercel.app/izin-staff-Linetgl.html" target="_blank" style="text-decoration: none;">
          <button type="button" class="gradient-btn"><i class="fas fa-tachometer-alt"></i> Dashboard Data</button>
        </a>
      </div>

      <!-- Popup Overlay -->
      <div id="popupOverlay">
        <div id="popupNotification">
          <p id="popupMessage"></p>
          <button onclick="hidePopup()" style="margin-top: 20px; background: rgba(255, 71, 87, 0.2); color: #ff6b6b; border-color: rgba(255,71,87,0.3);" class="gradient-btn">
            <i class="fas fa-times"></i> Close
          </button>
        </div>
      </div>

      <div class="account-actions-container">
        <div class="account-actions">
          <button class="logout-btn" id="logoutButton"><i class="fas fa-sign-out-alt"></i> Logout</button>
          <button type="button" class="change-password-btn" id="changePasswordButton">
            <i class="fas fa-key"></i> Ganti Password
          </button>
        </div>
      </div>
    </div>
  </div>

  <script>
    // ============================================
    // KONFIGURASI OPTIMAL
    // ============================================
    const SPREADSHEET_ID = '1JcZW0LC1-4l0GlFS_UQEZwrCC2OrXfQKh-Kr5opOdZs';
    const SHEET_NAMES = {
      REGISTER: 'Register',
      ACCESS: 'Access',
      WHITELIST: 'Whitelist IP',
      JOBDESK: 'Jobdesk',
      BACKGROUND: 'background',
      DATABASE: 'DATABASE LINETOGEL'
    };

    // Google Apps Script URL
    const GOOGLE_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbzCrbbVEeEgEq8L0a4w8-SPJBoRQg7rDV9h6mOt4OQ82oeuoL6AgdSwE1DzwjhAdEc/exec';

    // ============================================
    // KONFIGURASI BATAS PER ROLE
    // ============================================
    const MAX_LIMITS_BY_ROLE = {
      'KS': 3,
      'CS LINE': 2,
      'KKS': 2,
      'KHMER': 1,
      'DEFAULT': 4
    };

    // ============================================
    // VARIABEL GLOBAL
    // ============================================
    let currentUser = null;
    let userData = null;
    let jobdeskList = [];
    let accessStatus = 'OFF';
    let backgroundImages = [];
    let currentBackgroundIndex = 0;
    let currentIP = '';
    let attendanceRecords = [];
    let todayStartCount = 0;
    let isMaxLimitReached = false;
    let isBlocked = false;

    // Cache untuk performa
    let userDataCache = null;
    let jobdeskCache = null;
    let accessCache = null;
    let backgroundCache = null;

    // Interval timers
    let statusPanelTimer = null;
    let realtimeUpdateInterval = null;
    let clockInterval = null;
    let limitCheckInterval = null;

    // ============================================
    // DOM ELEMENTS
    // ============================================
    const elements = {
      loadingSpinner: document.getElementById('loadingSpinner'),
      loadingText: document.getElementById('loadingText'),
      loginForm: document.getElementById('loginForm'),
      dashboard: document.getElementById('dashboard'),
      username: document.getElementById('username'),
      password: document.getElementById('password'),
      errorMessage: document.getElementById('error-message'),
      ipWhitelistMessage: document.getElementById('ipWhitelistMessage'),
      staffNameDisplay: document.getElementById('staffNameDisplay'),
      userRoleDisplay: document.getElementById('userRoleDisplay'),
      limitInfoDisplay: document.getElementById('limitInfoDisplay'),
      jobdeskSection: document.getElementById('jobdeskSection'),
      jobdeskSelect: document.getElementById('jobdesk'),
      jobdeskError: document.getElementById('jobdeskError'),
      popupOverlay: document.getElementById('popupOverlay'),
      popupMessage: document.getElementById('popupMessage'),
      backgroundImage: document.getElementById('backgroundImage'),
      statusIndicator: document.getElementById('statusIndicator'),
      statusText: document.getElementById('statusText'),
      currentIPText: document.getElementById('currentIPText'),
      ipDisplay: document.getElementById('ipDisplay'),
      realtimeIndicator: document.getElementById('realtimeIndicator'),
      updateNotification: document.getElementById('updateNotification'),
      updateMessage: document.getElementById('updateMessage'),
      timeWarning: document.getElementById('timeWarning'),
      warningText: document.getElementById('warningText'),
      maxLimitAlert: document.getElementById('maxLimitAlert'),
      maxLimitAlertMessage: document.getElementById('maxLimitAlertMessage'),
      maxLimitModal: document.getElementById('maxLimitModal'),
      maxLimitMessage: document.getElementById('maxLimitMessage'),
      blockedDashboard: document.getElementById('blockedDashboard'),
      normalDashboard: document.getElementById('normalDashboard'),
      blockedMessage: document.getElementById('blockedMessage'),
      logoutButtonBlocked: document.getElementById('logoutButtonBlocked'),
      statusPanel: document.getElementById('statusPanel'),
      statusPanelIcon: document.getElementById('statusPanelIcon'),
      statusPanelTitle: document.getElementById('statusPanelTitle'),
      statusPanelTime: document.getElementById('statusPanelTime'),
      statusPanelDuration: document.getElementById('statusPanelDuration'),
      statusPanelInfo: document.getElementById('statusPanelInfo'),
      statusPanelContent: document.getElementById('statusPanelContent'),
      passwordChangeModal: document.getElementById('passwordChangeModal'),
      modalOldPassword: document.getElementById('modalOldPassword'),
      modalNewPassword: document.getElementById('modalNewPassword'),
      modalConfirmPassword: document.getElementById('modalConfirmPassword'),
      passwordMessage: document.getElementById('passwordMessage'),
      modalSavePasswordBtn: document.getElementById('modalSavePasswordBtn'),
      modalCancelPasswordBtn: document.getElementById('modalCancelPasswordBtn'),
      loginButton: document.getElementById('loginButton'),
      startTimeButton: document.getElementById('startTimeButton'),
      endTimeButton: document.getElementById('endTimeButton'),
      logoutButton: document.getElementById('logoutButton'),
      changePasswordButton: document.getElementById('changePasswordButton')
    };

    // ============================================
    // FUNGSI UTILITAS OPTIMAL
    // ============================================

    // Format tanggal dan waktu
    function getFormattedDate(date) {
      return date.toISOString().split('T')[0];
    }

    function getFormattedTime(date) {
      return date.toTimeString().split(' ')[0];
    }

    // Normalisasi role untuk pencarian
    function normalizeRole(role) {
      if (!role) return '';
      const roleUpper = role.toUpperCase().trim();
      
      if (roleUpper.includes('KS') && !roleUpper.includes('KKS')) return 'KS';
      if (roleUpper.includes('CS LINE') || roleUpper.includes('CSLINE')) return 'CS LINE';
      if (roleUpper.includes('KKS')) return 'KKS';
      if (roleUpper.includes('KHMER')) return 'KHMER';
      
      return roleUpper;
    }

    // Dapatkan batas maksimal berdasarkan role
    function getMaxLimitByRole(role) {
      const normalizedRole = normalizeRole(role);
      return MAX_LIMITS_BY_ROLE[normalizedRole] || MAX_LIMITS_BY_ROLE.DEFAULT;
    }

    // ============================================
    // FUNGSI TOGGLE PASSWORD
    // ============================================
    function togglePasswordVisibility() {
      const passwordInput = document.getElementById("password");
      const toggleIcon = document.getElementById("togglePassword");

      if (passwordInput.type === "password") {
        passwordInput.type = "text";
        toggleIcon.classList.replace("fa-eye", "fa-eye-slash");
        toggleIcon.style.color = "#00d2ff";
      } else {
        passwordInput.type = "password";
        toggleIcon.classList.replace("fa-eye-slash", "fa-eye");
        toggleIcon.style.color = "rgba(255, 255, 255, 0.5)";
      }
    }

    function toggleModalPassword(inputId, iconId) {
      const input = document.getElementById(inputId);
      const icon = document.getElementById(iconId);

      if (input.type === "password") {
        input.type = "text";
        icon.classList.replace("fa-eye", "fa-eye-slash");
        icon.style.color = "#00d2ff";
      } else {
        input.type = "password";
        icon.classList.replace("fa-eye-slash", "fa-eye");
        icon.style.color = "rgba(255, 255, 255, 0.5)";
      }
    }

    // ============================================
    // FUNGSI STATUS PANEL OPTIMAL
    // ============================================
    function updateStatusPanel() {
      if (!currentUser) return;

      const today = getFormattedDate(new Date());
      const records = JSON.parse(localStorage.getItem('attendanceRecords') || '[]');
      let activeRecord = null;

      for (let record of records) {
        if (record.tanggal === today && 
            record.username === currentUser.username && 
            record.attendance_status === 'Active') {
          activeRecord = record;
          break;
        }
      }

      if (activeRecord) {
        elements.statusPanel.classList.add('active');
        elements.statusPanelIcon.className = 'fas fa-door-open';
        elements.statusPanelTitle.textContent = 'Sedang Izin Keluar';

        elements.statusPanelTime.innerHTML = `<div class="status-time">Mulai: ${activeRecord.waktu_mulai}</div>`;

        const startTime = activeRecord.waktu_mulai.split(':').map(Number);
        const now = new Date();
        const startDate = new Date();
        startDate.setHours(startTime[0], startTime[1], startTime[2] || 0, 0);

        let durationMs = now - startDate;
        if (durationMs < 0) durationMs += 86400000; // 24 jam dalam milidetik

        const hours = Math.floor(durationMs / 3600000);
        const minutes = Math.floor((durationMs % 3600000) / 60000);
        const seconds = Math.floor((durationMs % 60000) / 1000);

        elements.statusPanelDuration.innerHTML = `
          <div class="status-duration">
            <i class="far fa-clock"></i>
            <span>${hours}j ${minutes}m ${seconds}d</span>
          </div>`;

        elements.statusPanelInfo.innerHTML = `Klik "Kembali Masuk" untuk selesaikan izin`;

      } else {
        elements.statusPanel.classList.remove('active');
        elements.statusPanelIcon.className = 'fas fa-briefcase';
        elements.statusPanelTitle.textContent = 'Sudah Kembai ke Office';

        const maxLimit = getMaxLimitByRole(currentUser.role);
        const remaining = maxLimit - todayStartCount;

        if (todayStartCount > 0) {
          elements.statusPanelTime.innerHTML = `<div class="status-time">${todayStartCount} izin hari ini</div>`;
          elements.statusPanelDuration.innerHTML = `
            <div class="status-duration">
              <i class="fas fa-history"></i>
              <span>Sisa: ${remaining} kali</span>
            </div>`;

          if (remaining > 0) {
            elements.statusPanelInfo.innerHTML = `Bisa izin keluar ${remaining} kali lagi`;
          } else {
            elements.statusPanelInfo.innerHTML = `Batas izin hari ini telah habis`;
          }
        } else {
          elements.statusPanelTime.innerHTML = `<div class="status-time">Selamat bekerja</div>`;
          elements.statusPanelDuration.innerHTML = `
            <div class="status-duration">
              <i class="fas fa-history"></i>
              <span>Sisa: ${remaining} kali</span>
            </div>`;
          elements.statusPanelInfo.innerHTML = `Klik "Izin Keluar" untuk mulai izin`;
        }
      }
    }

    function startStatusPanelTimer() {
      stopStatusPanelTimer();
      updateStatusPanel();
      statusPanelTimer = setInterval(updateStatusPanel, 1000);
    }

    function stopStatusPanelTimer() {
      if (statusPanelTimer) {
        clearInterval(statusPanelTimer);
        statusPanelTimer = null;
      }
    }

    // ============================================
    // FUNGSI CHECK LIMIT OPTIMAL (CROSS-DEVICE)
    // ============================================
    async function checkStartTimeLimit() {
      try {
        if (!currentUser?.username) {
          return { success: false, count: 0, maxCount: 4, remaining: 4 };
        }

        const maxLimit = getMaxLimitByRole(currentUser.role);
        
        // Cek dari server
        const response = await fetch(`${GOOGLE_SCRIPT_URL}?action=checkStartTimeLimit&username=${encodeURIComponent(currentUser.username)}`);
        const serverData = await response.json();
        
        // Cek dari localStorage (cross-device sync)
        const today = getFormattedDate(new Date());
        const syncKey = `limit_sync_${currentUser.username}_${today}`;
        const localData = localStorage.getItem(syncKey);
        let localCount = 0;
        
        if (localData) {
          try {
            const parsed = JSON.parse(localData);
            localCount = parsed.count || 0;
          } catch (e) {
            console.error('Error parsing local limit data:', e);
          }
        }
        
        // Gunakan yang lebih besar antara server dan local
        const finalCount = Math.max(serverData.count || 0, localCount);
        todayStartCount = finalCount;
        
        const remaining = Math.max(0, maxLimit - finalCount);
        const hardStop = finalCount >= maxLimit;
        
        return {
          success: true,
          count: finalCount,
          maxCount: maxLimit,
          remaining: remaining,
          hardStop: hardStop,
          message: `Role ${currentUser.role}: ${finalCount}/${maxLimit} izin hari ini`
        };
        
      } catch (error) {
        console.error('Error checking limit:', error);
        return { 
          success: false, 
          count: 0, 
          maxCount: getMaxLimitByRole(currentUser?.role),
          remaining: getMaxLimitByRole(currentUser?.role),
          hardStop: false 
        };
      }
    }

    // Fungsi untuk sync limit ke semua device
    function syncLimitToAllDevices(count) {
      if (!currentUser) return;
      
      const today = getFormattedDate(new Date());
      const syncData = {
        username: currentUser.username,
        role: currentUser.role,
        count: count,
        date: today,
        timestamp: Date.now(),
        ip: currentIP
      };
      
      // Simpan di localStorage
      const syncKey = `limit_sync_${currentUser.username}_${today}`;
      localStorage.setItem(syncKey, JSON.stringify(syncData));
      
      // Kirim ke server untuk sync (non-blocking)
      setTimeout(() => {
        fetch(`${GOOGLE_SCRIPT_URL}?action=updateLimitSync`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(syncData)
        }).catch(err => console.warn('Sync error (non-critical):', err));
      }, 100);
    }

    // ============================================
    // FUNGSI UPDATE UI BERDASARKAN LIMIT
    // ============================================
    function updateStartCounterUI(limitData) {
      if (!currentUser) return;
      
      const userRole = currentUser.role;
      const normalizedRole = normalizeRole(userRole);
      const maxLimit = getMaxLimitByRole(userRole);
      
      if (limitData.success) {
        todayStartCount = limitData.count || 0;
        const remaining = limitData.remaining || Math.max(0, maxLimit - todayStartCount);
        
        // Update info batas
        elements.limitInfoDisplay.textContent = `${todayStartCount}/${maxLimit} kali (${remaining} sisa)`;
        
        // Update status panel info
        elements.statusPanelInfo.innerHTML = 
          `Role: ${userRole} | Batas: ${todayStartCount}/${maxLimit} kali | Sisa: ${remaining} kali`;
        
        // Cek apakah sudah melebihi batas
        let roleLimit = maxLimit;
        if (normalizedRole === 'KS') roleLimit = 3;
        else if (normalizedRole === 'CS LINE') roleLimit = 2;
        else if (normalizedRole === 'KKS') roleLimit = 2;
        else if (normalizedRole === 'KHMER') roleLimit = 1;
        
        const isOverLimit = todayStartCount >= roleLimit;
        
        if (isOverLimit && !checkActiveRecord()) {
          isBlocked = true;
          
          // Update alert message
          const alertMessage = `
            Role <strong>${userRole}</strong> hanya boleh izin keluar 
            <strong>${roleLimit} kali</strong> per hari.<br>
            Anda sudah menggunakan ${todayStartCount} kali.<br>
            Silakan lanjut besok!
          `;
          
          elements.maxLimitAlertMessage.innerHTML = alertMessage;
          elements.maxLimitAlert.style.display = 'block';
          
          elements.blockedMessage.innerHTML = `
            Role <strong>${userRole}</strong> maksimal ${roleLimit} kali izin keluar per hari.<br>
            Anda telah mencapai batas maksimal (${todayStartCount} kali).<br>
            Silakan lanjut besok!
          `;
          
          elements.normalDashboard.style.display = 'none';
          elements.blockedDashboard.style.display = 'block';
          
          elements.startTimeButton.disabled = true;
          elements.startTimeButton.classList.add('disabled-btn');
          elements.startTimeButton.innerHTML = `<i class="fas fa-ban"></i> STOP (Batas ${roleLimit}x)`;
          
          // Update modal message
          elements.maxLimitMessage.innerHTML = alertMessage;
          
        } else {
          isBlocked = false;
          elements.maxLimitAlert.style.display = 'none';
          elements.normalDashboard.style.display = 'block';
          elements.blockedDashboard.style.display = 'none';
          
          if (!checkActiveRecord() && !isRestrictedTime() && todayStartCount < roleLimit) {
            elements.startTimeButton.disabled = false;
            elements.startTimeButton.classList.remove('disabled-btn');
            elements.startTimeButton.innerHTML = `<i class="fas fa-door-open"></i> Izin Keluar (${remaining} sisa)`;
          }
        }
      }
      
      updateStatusPanel();
    }

    function checkActiveRecord() {
      if (!currentUser) return false;
      
      const today = getFormattedDate(new Date());
      const records = JSON.parse(localStorage.getItem('attendanceRecords') || '[]');
      
      return records.some(record => 
        record.tanggal === today && 
        record.username === currentUser.username && 
        record.attendance_status === 'Active'
      );
    }

    function showMaxLimitModal() { 
      elements.maxLimitModal.style.display = 'flex'; 
    }
    
    function closeMaxLimitModal() { 
      elements.maxLimitModal.style.display = 'none'; 
    }

    // ============================================
    // FUNGSI WARNING JAM 23:50 - 00:01
    // ============================================
    function isRestrictedTime() {
      const now = new Date();
      const hours = now.getHours();
      const minutes = now.getMinutes();
      return (hours === 23 && minutes >= 50) || (hours === 0 && minutes <= 1);
    }

    function updateTimeRestriction() {
      const warningElement = elements.timeWarning;
      const warningText = elements.warningText;
      const startButton = elements.startTimeButton;

      if (isRestrictedTime()) {
        warningElement.style.display = 'block';
        warningText.textContent = '⚠️ Izin keluar tidak tersedia pada pukul 23:50 - 00:01 WIB ⚠️';
        startButton.disabled = true;
        startButton.classList.add('disabled-btn');
        startButton.innerHTML = '<i class="fas fa-ban"></i> Izin Keluar (Tidak Tersedia)';
        return true;
      } else {
        warningElement.style.display = 'none';
        if (!isBlocked && !checkActiveRecord() && todayStartCount < getMaxLimitByRole(currentUser?.role)) {
          startButton.disabled = false;
          startButton.classList.remove('disabled-btn');
          startButton.innerHTML = '<i class="fas fa-door-open"></i> Izin Keluar';
        }
        return false;
      }
    }

    // ============================================
    // FUNGSI START TIME OPTIMAL
    // ============================================
    async function startTime() {
      // Validasi waktu restriksi
      if (isRestrictedTime()) {
        showPopup(`<div style="color:#ffa502;text-align:center;">
          <i class="fas fa-exclamation-triangle fa-2x"></i><br>
          <strong>IZIN KELUAR TIDAK TERSEDIA!</strong><br>
          <small>Pukul 23:50 - 00:01 WIB</small>
        </div>`, 5000);
        return;
      }

      // Validasi limit berdasarkan role
      const limitCheck = await checkStartTimeLimit();
      const userRole = currentUser.role;
      const maxLimit = getMaxLimitByRole(userRole);
      
      if (!limitCheck.success) {
        showPopup(`<div style="color:#ffa502;text-align:center;">
          <i class="fas fa-exclamation-triangle fa-2x"></i><br>
          <strong>Gagal memeriksa batas izin keluar!</strong>
        </div>`, 5000);
        return;
      }
      
      if (limitCheck.count >= maxLimit) {
        showPopup(`<div style="color:#ff4757;text-align:center;">
          <i class="fas fa-ban fa-2x"></i><br>
          <strong>BATAS IZIN TELAH HABIS!</strong><br>
          <small>Role ${userRole} maksimal ${maxLimit} kali izin keluar per hari</small>
        </div>`, 5000);
        return;
      }

      // Validasi jobdesk jika diperlukan
      const selectedJobdesk = elements.jobdeskSelect.value;
      const requireJobdesk = ['ON', 'YES', 'TRUE', '1', 'ACTIVE', 'ENABLE'].includes(accessStatus);

      if (requireJobdesk && !selectedJobdesk) {
        elements.jobdeskError.style.display = 'block';
        showPopup('Silahkan pilih jobdesk terlebih dahulu', 3000);
        return;
      }

      elements.jobdeskError.style.display = 'none';

      // Cek apakah sudah ada izin aktif
      if (checkActiveRecord()) {
        showPopup(`<div style="color:#ffa502;text-align:center;">
          <i class="fas fa-exclamation-triangle fa-2x"></i><br>
          <strong>Anda sudah sedang keluar!</strong>
        </div>`, 5000);
        return;
      }

      try {
        const now = new Date();
        const dateStr = getFormattedDate(now);
        const timeStr = getFormattedTime(now);
        const dayName = now.toLocaleDateString('id-ID', { weekday: 'long' });
        const timestamp = now.getTime().toString();

        const attendanceData = {
          tanggal: dateStr,
          hari: dayName,
          username: currentUser.username,
          nama: currentUser.name,
          status: userRole,
          waktu_mulai: timeStr,
          waktu_selesai: '',
          jobdesk: selectedJobdesk || '',
          ip_address: currentIP,
          attendance_status: 'Active',
          session_id: timestamp
        };

        // 1. Simpan ke LocalStorage (Instant)
        const records = JSON.parse(localStorage.getItem('attendanceRecords') || '[]');
        records.push(attendanceData);
        localStorage.setItem('attendanceRecords', JSON.stringify(records));
        localStorage.setItem('currentSessionId', timestamp);

        // 2. Update counter dan sync
        todayStartCount++;
        syncLimitToAllDevices(todayStartCount);

        // 3. Update UI (Instant)
        if (selectedJobdesk) elements.jobdeskSelect.value = '';
        updateTimeButtonsUI(true);
        updateStartCounterUI({
          success: true,
          count: todayStartCount,
          maxCount: maxLimit,
          remaining: maxLimit - todayStartCount,
          hardStop: false
        });
        startStatusPanelTimer();

        // 4. Tampilkan feedback
        showPopup(`<div style="color:#2ed573;text-align:center;">
          <i class="fas fa-check-circle fa-2x"></i><br>
          <strong>Izin Keluar Berhasil!</strong><br>
          <small>${timeStr} | Menyimpan ke server...</small>
        </div>`, 3000);

        // 5. Simpan ke server (Background, non-blocking)
        setTimeout(() => {
          const databaseData = {
            sheetName: SHEET_NAMES.DATABASE,
            action: 'insert',
            data: attendanceData
          };
          writeToDatabaseSheet(databaseData);
        }, 1000);

      } catch (error) {
        console.error('Error starting izin keluar:', error);
        showPopup(`<div style="color:#ff4757;text-align:center;">
          <i class="fas fa-times-circle fa-2x"></i><br>
          <strong>Error Sistem!</strong>
        </div>`, 5000);
      }
    }

    // ============================================
    // FUNGSI END TIME OPTIMAL
    // ============================================
    async function endTime() {
      const now = new Date();
      const timeStr = getFormattedTime(now);
      const today = getFormattedDate(now);

      const records = JSON.parse(localStorage.getItem('attendanceRecords') || '[]');
      let activeRecordIndex = -1;
      let activeRecord = null;

      for (let i = 0; i < records.length; i++) {
        const record = records[i];
        if (record.tanggal === today && 
            record.username === currentUser.username && 
            record.attendance_status === 'Active') {
          activeRecordIndex = i;
          activeRecord = record;
          break;
        }
      }

      if (activeRecordIndex === -1) {
        showPopup(`<div style="color:#ffa502;text-align:center;">
          <i class="fas fa-exclamation-triangle fa-2x"></i><br>
          <strong>Tidak ada sesi izin keluar aktif!</strong>
        </div>`, 5000);
        return;
      }

      try {
        // Hitung durasi
        const startTimeStr = records[activeRecordIndex].waktu_mulai;
        const startParts = startTimeStr.split(':').map(Number);
        const endParts = timeStr.split(':').map(Number);
        
        const startDate = new Date();
        startDate.setHours(startParts[0], startParts[1], startParts[2] || 0, 0);
        const endDate = new Date();
        endDate.setHours(endParts[0], endParts[1], endParts[2] || 0, 0);
        
        if (endDate < startDate) endDate.setDate(endDate.getDate() + 1);
        
        const durationMs = endDate - startDate;
        const hours = Math.floor(durationMs / 3600000);
        const minutes = Math.floor((durationMs % 3600000) / 60000);
        const seconds = Math.floor((durationMs % 60000) / 1000);

        // 1. Update LocalStorage (Instant)
        records[activeRecordIndex].waktu_selesai = timeStr;
        records[activeRecordIndex].attendance_status = 'Completed';
        localStorage.setItem('attendanceRecords', JSON.stringify(records));
        localStorage.removeItem('currentSessionId');

        // 2. Update UI (Instant)
        updateTimeButtonsUI(false);
        updateStatusPanel();

        // 3. Tampilkan feedback
        showPopup(`<div style="color:#2ed573;text-align:center;">
          <i class="fas fa-check-circle fa-2x"></i><br>
          <strong>Kembali Masuk Berhasil!</strong><br>
          <small>Durasi: ${hours}j ${minutes}m ${seconds}d</small>
        </div>`, 3000);

        // 4. Update limit check
        setTimeout(async () => {
          const limitData = await checkStartTimeLimit();
          updateStartCounterUI(limitData);
        }, 500);

        // 5. Update ke server (Background)
        setTimeout(() => {
          const databaseData = {
            sheetName: SHEET_NAMES.DATABASE,
            action: 'update',
            data: records[activeRecordIndex]
          };
          writeToDatabaseSheet(databaseData);
        }, 1000);

      } catch (error) {
        console.error('Error ending izin keluar:', error);
        showPopup(`<div style="color:#ff4757;text-align:center;">
          <i class="fas fa-times-circle fa-2x"></i><br>
          <strong>Error Sistem!</strong>
        </div>`, 5000);
      }
    }

    // ============================================
    // FUNGSI UPDATE TIME BUTTONS UI
    // ============================================
    function updateTimeButtonsUI(isActive) {
      if (isActive) {
        elements.startTimeButton.disabled = true;
        elements.startTimeButton.style.opacity = '0.5';
        elements.endTimeButton.disabled = false;
        elements.endTimeButton.style.opacity = '1';
        elements.startTimeButton.innerHTML = '<i class="fas fa-door-open"></i> Sedang Keluar';
        elements.endTimeButton.innerHTML = '<i class="fas fa-sign-in-alt"></i> Kembali Masuk';
      } else {
        if (!isRestrictedTime() && todayStartCount < getMaxLimitByRole(currentUser?.role) && !isBlocked) {
          elements.startTimeButton.disabled = false;
          elements.startTimeButton.style.opacity = '1';
          const remaining = getMaxLimitByRole(currentUser?.role) - todayStartCount;
          elements.startTimeButton.innerHTML = `<i class="fas fa-door-open"></i> Izin Keluar (${remaining} sisa)`;
        }
        elements.endTimeButton.disabled = true;
        elements.endTimeButton.style.opacity = '0.5';
        elements.endTimeButton.innerHTML = '<i class="fas fa-sign-in-alt"></i> Tidak Aktif';
      }
    }

    // ============================================
    // FUNGSI LOGIN OPTIMAL
    // ============================================
    async function login() {
      const username = elements.username.value.trim();
      const password = elements.password.value.trim();

      if (!username || !password) {
        showError('Harap masukkan username dan password');
        return;
      }

      showLoading('Memeriksa kredensial...');
      
      try {
        // 1. Cek IP Whitelist pertama
        const isWhitelisted = await checkIPWhitelist();
        if (!isWhitelisted) {
          elements.ipWhitelistMessage.style.display = 'block';
          elements.ipWhitelistMessage.innerHTML = `
            <i class="fas fa-shield-alt"></i> IP Anda (${currentIP}) belum di-whitelist.<br>
            Hubungi administrator untuk meng-whitelist IP Anda.
          `;
          hideLoading();
          return;
        }

        // 2. Cek login dari cache/localStorage dulu untuk performa
        const cachedUser = await checkCachedLogin(username, password);
        if (cachedUser) {
          await handleSuccessfulLogin(cachedUser);
          return;
        }

        // 3. Jika tidak ada di cache, cek dari server
        const serverUser = await checkServerLogin(username, password);
        if (serverUser) {
          await handleSuccessfulLogin(serverUser);
        } else {
          showError('❌ Username atau Password salah!');
          hideLoading();
        }

      } catch (error) {
        console.error('Login error:', error);
        showError(`Login gagal: ${error.message}`);
        hideLoading();
      }
    }

    async function checkCachedLogin(username, password) {
      try {
        const registerData = await fetchGoogleSheetData(SHEET_NAMES.REGISTER, true);
        const userFound = findUserInRegisterData(registerData, username);
        
        if (userFound && userFound.password === password) {
          return userFound;
        }
        return null;
      } catch (error) {
        return null;
      }
    }

    async function checkServerLogin(username, password) {
      const formData = new FormData();
      formData.append('action', 'login');
      formData.append('username', username);
      formData.append('password', password);
      
      const response = await fetch(GOOGLE_SCRIPT_URL, {
        method: 'POST',
        body: formData
      });
      
      const result = await response.json();
      
      if (result.success && result.user) {
        return {
          username: result.user.username,
          name: result.user.name,
          role: result.user.role,
          password: password
        };
      }
      
      return null;
    }

    async function handleSuccessfulLogin(userFound) {
      currentUser = userFound;
      localStorage.setItem('currentUser', JSON.stringify(currentUser));
      localStorage.setItem('loginTime', new Date().toISOString());

      // Update UI
      updateUserUI();
      elements.loginForm.style.display = "none";
      elements.dashboard.style.display = "block";
      elements.dashboard.classList.remove("hidden");

      // Load data paralel untuk performa
      await Promise.all([
        loadAccessSettings(),
        loadJobdeskOptions(),
        loadBackgroundImages(),
        initializeDashboard()
      ]);

      // Tampilkan info role dan batas
      const maxLimit = getMaxLimitByRole(userFound.role);
      showPopup(`<div style="color:#2ed573;text-align:center;">
        <i class="fas fa-check-circle fa-2x"></i><br>
        <strong>Login berhasil!</strong><br>
        <small>Role: ${userFound.role} | Batas izin: ${maxLimit} kali/hari</small>
      </div>`, 4000);

      updateConnectionStatus(true, `Logged in as ${userFound.name}`);
      hideLoading();
    }

    // ============================================
    // FUNGSI DASHBOARD OPTIMAL
    // ============================================
    async function initializeDashboard() {
      // Check limit pertama kali
      const limitData = await checkStartTimeLimit();
      updateStartCounterUI(limitData);
      
      // Setup timers
      startStatusPanelTimer();
      startRealtimeUpdates();
      
      // Check active record untuk update UI
      if (checkActiveRecord()) {
        updateTimeButtonsUI(true);
      } else {
        updateTimeButtonsUI(false);
      }
      
      // Setup interval untuk periodic checks
      limitCheckInterval = setInterval(async () => {
        if (currentUser && !isBlocked) {
          const limitData = await checkStartTimeLimit();
          updateStartCounterUI(limitData);
        }
      }, 30000); // Check setiap 30 detik
    }

    function updateUserUI() {
      if (currentUser) {
        const maxLimit = getMaxLimitByRole(currentUser.role);
        elements.staffNameDisplay.textContent = currentUser.name || currentUser.username;
        elements.userRoleDisplay.textContent = currentUser.role;
        elements.limitInfoDisplay.textContent = `Maksimal ${maxLimit} kali/hari`;
      }
    }

    // ============================================
    // FUNGSI DATA FETCH OPTIMAL
    // ============================================
    async function fetchGoogleSheetData(sheetName, background = false) {
      if (!background) showLoading(`Memuat ${sheetName}...`);
      
      try {
        const cacheKey = `cache_${sheetName}`;
        const cacheTimeKey = `cache_time_${sheetName}`;
        const now = Date.now();
        
        // Cek cache (5 menit)
        const cachedData = localStorage.getItem(cacheKey);
        const cacheTime = localStorage.getItem(cacheTimeKey);
        
        if (cachedData && cacheTime && (now - parseInt(cacheTime)) < 300000) {
          if (!background) hideLoading();
          return JSON.parse(cachedData);
        }
        
        // Fetch dari server
        const url = `https://opensheet.elk.sh/${SPREADSHEET_ID}/${sheetName}`;
        const response = await fetch(url);
        
        if (!response.ok) throw new Error(`HTTP ${response.status}`);
        
        const data = await response.json();
        
        // Simpan ke cache
        localStorage.setItem(cacheKey, JSON.stringify(data));
        localStorage.setItem(cacheTimeKey, now.toString());
        
        if (!background) hideLoading();
        return data;
        
      } catch (error) {
        console.error(`Error loading ${sheetName}:`, error);
        if (!background) hideLoading();
        return [];
      }
    }

    function findUserInRegisterData(registerData, username) {
      if (!registerData || !username) return null;
      
      for (let row of registerData) {
        let rowUsername = '', rowPassword = '', rowName = '', rowRole = '';
        
        for (const [key, value] of Object.entries(row)) {
          const keyLower = key.toLowerCase().trim();
          const valueStr = String(value).trim();
          
          if (keyLower.includes('username') || key === 'A') rowUsername = valueStr;
          if (keyLower.includes('password') || key === 'B') rowPassword = valueStr;
          if (keyLower.includes('name') || key === 'C') rowName = valueStr;
          if (keyLower.includes('status') || key.includes('role') || key === 'D') rowRole = valueStr;
        }
        
        if (rowUsername.toLowerCase() === username.toLowerCase()) {
          return {
            username: rowUsername,
            password: rowPassword,
            name: rowName || rowUsername,
            role: rowRole || 'Staff'
          };
        }
      }
      
      return null;
    }

    // ============================================
    // FUNGSI IP WHITELIST
    // ============================================
    async function checkIPWhitelist() {
      try {
        const whitelistData = await fetchGoogleSheetData(SHEET_NAMES.WHITELIST, true);
        
        for (let row of whitelistData) {
          for (const value of Object.values(row)) {
            const ipFromSheet = String(value).trim();
            if (!ipFromSheet) continue;
            
            if (ipFromSheet === currentIP) return true;
            
            if (ipFromSheet.includes('*')) {
              const ipPattern = ipFromSheet.replace(/\*/g, '.*');
              const regex = new RegExp(`^${ipPattern}$`);
              if (regex.test(currentIP)) return true;
            }
          }
        }
        
        return false;
      } catch (error) {
        console.error('Error checking IP whitelist:', error);
        return true; // Allow access if check fails
      }
    }

    // ============================================
    // FUNGSI LOAD DATA OPTIMAL
    // ============================================
    async function loadAccessSettings() {
      try {
        const accessData = await fetchGoogleSheetData(SHEET_NAMES.ACCESS, true);
        accessStatus = extractAccessStatus(accessData);
        updateAccessUI();
      } catch (error) {
        console.error('Error loading access settings:', error);
        accessStatus = 'OFF';
        elements.jobdeskSection.classList.add('hidden');
      }
    }

    async function loadJobdeskOptions() {
      try {
        const jobdeskData = await fetchGoogleSheetData(SHEET_NAMES.JOBDESK, true);
        jobdeskList = extractJobdeskOptions(jobdeskData);
        updateJobdeskDropdown(jobdeskList);
      } catch (error) {
        console.error('Error loading jobdesk options:', error);
      }
    }

    async function loadBackgroundImages() {
      try {
        const backgroundData = await fetchGoogleSheetData(SHEET_NAMES.BACKGROUND, true);
        backgroundImages = extractBackgroundImages(backgroundData);
        
        if (backgroundImages.length > 0) {
          elements.backgroundImage.src = backgroundImages[0];
          setTimeout(() => elements.backgroundImage.classList.add('active'), 100);
          
          if (backgroundImages.length > 1) {
            startBackgroundSlideshow();
          }
        }
      } catch (error) {
        console.error('Error loading background images:', error);
      }
    }

    function extractAccessStatus(accessData) {
      for (let row of accessData) {
        for (const [key, value] of Object.entries(row)) {
          const keyLower = key.toLowerCase();
          if (keyLower.includes('jobdesk') || keyLower.includes('access')) {
            return String(value).toUpperCase().trim();
          }
        }
      }
      return 'OFF';
    }

    function extractJobdeskOptions(jobdeskData) {
      const options = [];
      for (let row of jobdeskData) {
        for (const value of Object.values(row)) {
          const jobdesk = String(value).trim();
          if (jobdesk && !options.includes(jobdesk)) {
            options.push(jobdesk);
          }
        }
      }
      return options;
    }

    function extractBackgroundImages(backgroundData) {
      const images = [];
      for (let row of backgroundData) {
        for (const value of Object.values(row)) {
          const url = String(value).trim();
          if (url.startsWith('http')) {
            images.push(url);
          }
        }
      }
      return images;
    }

    function updateJobdeskDropdown(options) {
      elements.jobdeskSelect.innerHTML = '<option value="">-- Silahkan Pilih --</option>';
      options.forEach(option => {
        const opt = document.createElement('option');
        opt.value = option;
        opt.textContent = option;
        elements.jobdeskSelect.appendChild(opt);
      });
    }

    function updateAccessUI() {
      const requireJobdesk = ['ON', 'YES', 'TRUE', '1', 'ACTIVE', 'ENABLE'].includes(accessStatus);
      if (requireJobdesk) {
        elements.jobdeskSection.classList.remove('hidden');
      } else {
        elements.jobdeskSection.classList.add('hidden');
      }
    }

    // ============================================
    // FUNGSI BACKGROUND SLIDESHOW
    // ============================================
    function startBackgroundSlideshow() {
      if (backgroundImages.length <= 1) return;
      
      setInterval(() => {
        currentBackgroundIndex = (currentBackgroundIndex + 1) % backgroundImages.length;
        elements.backgroundImage.classList.remove('active');
        
        setTimeout(() => {
          elements.backgroundImage.src = backgroundImages[currentBackgroundIndex];
          setTimeout(() => elements.backgroundImage.classList.add('active'), 100);
        }, 1000);
      }, 10000);
    }

    // ============================================
    // FUNGSI REALTIME UPDATES
    // ============================================
    function startRealtimeUpdates() {
      console.log('Starting real-time updates...');
      elements.realtimeIndicator.style.display = 'flex';
      
      realtimeUpdateInterval = setInterval(async () => {
        try {
          await Promise.allSettled([
            checkUserDataUpdates(),
            checkJobdeskUpdates(),
            checkAccessUpdates(),
            checkBackgroundUpdates()
          ]);
        } catch (error) {
          console.error('Error in realtime updates:', error);
        }
      }, 30000); // Setiap 30 detik
    }

    function stopRealtimeUpdates() {
      if (realtimeUpdateInterval) {
        clearInterval(realtimeUpdateInterval);
        realtimeUpdateInterval = null;
      }
      elements.realtimeIndicator.style.display = 'none';
    }

    async function checkUserDataUpdates() {
      try {
        const latestData = await fetchGoogleSheetData(SHEET_NAMES.REGISTER, true);
        const latestUserData = findUserInRegisterData(latestData, currentUser?.username);
        
        if (latestUserData && userDataCache) {
          const hasChanges = 
            latestUserData.name !== userDataCache.name ||
            latestUserData.role !== userDataCache.role;
            
          if (hasChanges) {
            currentUser.name = latestUserData.name;
            currentUser.role = latestUserData.role;
            localStorage.setItem('currentUser', JSON.stringify(currentUser));
            updateUserUI();
            showUpdateNotification('Profile updated');
          }
          userDataCache = latestUserData;
        }
      } catch (error) {
        console.error('Error checking user data updates:', error);
      }
    }

    async function checkJobdeskUpdates() {
      try {
        const latestData = await fetchGoogleSheetData(SHEET_NAMES.JOBDESK, true);
        const latestOptions = extractJobdeskOptions(latestData);
        
        if (JSON.stringify(latestOptions) !== JSON.stringify(jobdeskCache)) {
          jobdeskList = latestOptions;
          updateJobdeskDropdown(latestOptions);
          jobdeskCache = latestOptions;
          showUpdateNotification('Jobdesk options updated');
        }
      } catch (error) {
        console.error('Error checking jobdesk updates:', error);
      }
    }

    async function checkAccessUpdates() {
      try {
        const latestData = await fetchGoogleSheetData(SHEET_NAMES.ACCESS, true);
        const latestStatus = extractAccessStatus(latestData);
        
        if (latestStatus !== accessCache) {
          accessStatus = latestStatus;
          updateAccessUI();
          accessCache = latestStatus;
          showUpdateNotification('Access settings updated');
        }
      } catch (error) {
        console.error('Error checking access updates:', error);
      }
    }

    async function checkBackgroundUpdates() {
      try {
        const latestData = await fetchGoogleSheetData(SHEET_NAMES.BACKGROUND, true);
        const latestBackgrounds = extractBackgroundImages(latestData);
        
        if (JSON.stringify(latestBackgrounds) !== JSON.stringify(backgroundCache)) {
          backgroundImages = latestBackgrounds;
          backgroundCache = latestBackgrounds;
          showUpdateNotification('Backgrounds updated');
        }
      } catch (error) {
        console.error('Error checking background updates:', error);
      }
    }

    function showUpdateNotification(message) {
      elements.updateMessage.textContent = message;
      elements.updateNotification.style.display = 'flex';
      
      setTimeout(() => {
        elements.updateNotification.style.display = 'none';
      }, 3000);
    }

    // ============================================
    // FUNGSI WRITE TO DATABASE
    // ============================================
    async function writeToDatabaseSheet(data) {
      try {
        const formData = new FormData();
        formData.append('action', data.action);
        formData.append('sheetName', data.sheetName);
        formData.append('data', JSON.stringify(data.data));
        
        const response = await fetch(GOOGLE_SCRIPT_URL, {
          method: 'POST',
          body: formData
        });
        
        if (response.ok) {
          console.log('Data saved successfully');
          return true;
        }
        
        saveToLocalBackup(data);
        return false;
        
      } catch (error) {
        console.error('Error writing to Google Sheets:', error);
        saveToLocalBackup(data);
        return false;
      }
    }

    function saveToLocalBackup(data) {
      try {
        const backups = JSON.parse(localStorage.getItem('databaseBackups') || '[]');
        backups.push({
          data: data,
          timestamp: new Date().toISOString()
        });
        localStorage.setItem('databaseBackups', JSON.stringify(backups));
      } catch (error) {
        console.error('Error saving to local backup:', error);
      }
    }

    // ============================================
    // FUNGSI PASSWORD CHANGE
    // ============================================
    function showPasswordChangeModal() {
      elements.modalOldPassword.value = '';
      elements.modalNewPassword.value = '';
      elements.modalConfirmPassword.value = '';
      elements.passwordMessage.style.display = 'none';
      elements.passwordChangeModal.style.display = 'flex';
    }

    function closePasswordChangeModal() {
      elements.passwordChangeModal.style.display = 'none';
    }

    async function changePassword() {
      const oldPassword = elements.modalOldPassword.value.trim();
      const newPassword = elements.modalNewPassword.value.trim();
      const confirmPassword = elements.modalConfirmPassword.value.trim();

      // Validasi
      if (!oldPassword || !newPassword || !confirmPassword) {
        showPasswordMessage('Semua field harus diisi!', 'error');
        return;
      }
      if (newPassword !== confirmPassword) {
        showPasswordMessage('Password baru dan konfirmasi tidak cocok!', 'error');
        return;
      }
      if (oldPassword === newPassword) {
        showPasswordMessage('Password baru harus berbeda dengan password lama!', 'error');
        return;
      }

      showLoading('Mengubah password...');
      
      try {
        const formData = new FormData();
        formData.append('action', 'changePassword');
        formData.append('username', currentUser.username);
        formData.append('oldPassword', oldPassword);
        formData.append('newPassword', newPassword);

        const response = await fetch(GOOGLE_SCRIPT_URL, {
          method: 'POST',
          body: formData
        });
        
        const result = await response.json();

        if (result.success) {
          showPasswordMessage('Password berhasil diubah!', 'success');
          
          // Update local user data
          currentUser.password = newPassword;
          localStorage.setItem('currentUser', JSON.stringify(currentUser));
          
          setTimeout(() => {
            closePasswordChangeModal();
            showPopup(`<div style="color:#2ed573;text-align:center;">
              <i class="fas fa-check-circle fa-2x"></i><br>
              <strong>Password Berhasil Diubah!</strong>
            </div>`, 3000);
          }, 2000);
        } else {
          showPasswordMessage(result.message || 'Gagal mengubah password!', 'error');
        }
      } catch (error) {
        console.error('Error changing password:', error);
        showPasswordMessage('Terjadi kesalahan saat mengubah password', 'error');
      } finally {
        hideLoading();
      }
    }

    function showPasswordMessage(message, type) {
      elements.passwordMessage.textContent = message;
      elements.passwordMessage.className = `password-message ${type}`;
      elements.passwordMessage.style.display = 'block';
      
      setTimeout(() => {
        elements.passwordMessage.style.display = 'none';
      }, 5000);
    }

    // ============================================
    // FUNGSI LOGOUT OPTIMAL
    // ============================================
    function logout() {
      // Stop semua timers
      stopStatusPanelTimer();
      stopRealtimeUpdates();
      clearInterval(clockInterval);
      clearInterval(limitCheckInterval);
      
      // Reset semua variabel
      currentUser = null;
      userData = null;
      jobdeskList = [];
      accessStatus = 'OFF';
      backgroundImages = [];
      currentBackgroundIndex = 0;
      attendanceRecords = [];
      todayStartCount = 0;
      isMaxLimitReached = false;
      isBlocked = false;
      
      // Clear localStorage
      localStorage.removeItem('currentUser');
      localStorage.removeItem('loginTime');
      localStorage.removeItem('currentSessionId');
      
      // Reset form
      elements.username.value = '';
      elements.password.value = '';
      elements.jobdeskSelect.value = '';
      elements.modalOldPassword.value = '';
      elements.modalNewPassword.value = '';
      elements.modalConfirmPassword.value = '';
      
      // Reset UI
      elements.passwordChangeModal.style.display = 'none';
      elements.jobdeskError.style.display = 'none';
      elements.errorMessage.textContent = '';
      elements.errorMessage.style.display = 'none';
      elements.ipWhitelistMessage.style.display = 'none';
      elements.jobdeskSection.classList.add('hidden');
      elements.maxLimitAlert.style.display = 'none';
      elements.normalDashboard.style.display = 'block';
      elements.blockedDashboard.style.display = 'none';
      
      elements.statusPanel.classList.remove('active');
      elements.statusPanelTitle.textContent = 'Status Izin';
      elements.statusPanelTime.innerHTML = '';
      elements.statusPanelDuration.innerHTML = '';
      elements.statusPanelInfo.innerHTML = '';
      
      elements.dashboard.style.display = 'none';
      elements.loginForm.style.display = 'block';
      
      // Reset password toggle
      const passwordInput = document.getElementById('password');
      const toggleIcon = document.getElementById('togglePassword');
      if (passwordInput) passwordInput.type = "password";
      if (toggleIcon) {
        toggleIcon.classList.remove("fa-eye-slash");
        toggleIcon.classList.add("fa-eye");
      }
      
      // Show logout message
      updateConnectionStatus(true, 'Connected - Please login');
      showPopup(`<div style="color:#2ed573;text-align:center;">
        <i class="fas fa-check-circle fa-2x"></i><br>
        <strong>Logout Berhasil!</strong>
      </div>`, 3000);
    }

    // ============================================
    // FUNGSI CLOCK
    // ============================================
    function updateClock() {
      const now = new Date();
      const timeStr = now.toTimeString().split(' ')[0];
      
      const clockElement = document.getElementById('MyClockDisplay');
      if (clockElement) {
        clockElement.textContent = timeStr;
        
        if (isRestrictedTime()) {
          clockElement.style.color = '#ff4757';
          clockElement.style.textShadow = '0 0 10px rgba(255, 71, 87, 0.8)';
        } else {
          clockElement.style.color = '#00f2ff';
          clockElement.style.textShadow = '0 0 10px rgba(0, 242, 255, 0.5)';
        }
      }
    }

    // ============================================
    // FUNGSI GET USER IP
    // ============================================
    async function getUserIP() {
      try {
        const response = await fetch('https://api.ipify.org?format=json');
        const data = await response.json();
        currentIP = data.ip;
        elements.currentIPText.textContent = currentIP;
        return currentIP;
      } catch (error) {
        console.error('Error getting IP:', error);
        currentIP = '127.0.0.1';
        elements.currentIPText.textContent = 'Unknown IP';
        return currentIP;
      }
    }

    // ============================================
    // FUNGSI UI HELPER
    // ============================================
    function showLoading(message = 'Loading...') {
      elements.loadingText.textContent = message;
      elements.loadingSpinner.style.display = 'flex';
    }

    function hideLoading() {
      elements.loadingSpinner.style.display = 'none';
    }

    function showError(message) {
      elements.errorMessage.innerHTML = `<i class="fas fa-exclamation-circle"></i> ${message}`;
      elements.errorMessage.style.display = 'block';
    }

    function showPopup(message, duration = 5000) {
      elements.popupMessage.innerHTML = message;
      elements.popupOverlay.style.display = 'flex';
      
      setTimeout(() => {
        if (elements.popupOverlay.style.display === 'flex') {
          hidePopup();
        }
      }, duration);
    }

    function hidePopup() {
      elements.popupOverlay.style.display = 'none';
    }

    function updateConnectionStatus(isConnected, message) {
      if (isConnected) {
        elements.statusIndicator.className = 'status-indicator status-connected';
        elements.statusText.textContent = message;
      } else {
        elements.statusIndicator.className = 'status-indicator status-disconnected';
        elements.statusText.textContent = message;
      }
    }

    // ============================================
    // FUNGSI CHECK LOGIN STATUS
    // ============================================
    function checkLoginStatus() {
      try {
        const savedUser = localStorage.getItem('currentUser');
        const loginTime = localStorage.getItem('loginTime');
        
        if (savedUser && loginTime) {
          const loginDate = new Date(loginTime);
          const now = new Date();
          const hoursDiff = (now - loginDate) / 3600000; // hours
          
          if (hoursDiff < 8) { // Session 8 jam
            currentUser = JSON.parse(savedUser);
            loadDashboard();
            startStatusPanelTimer();
            startRealtimeUpdates();
            
            // Check limit setelah login
            setTimeout(async () => {
              const limitData = await checkStartTimeLimit();
              updateStartCounterUI(limitData);
            }, 1000);
            
            return true;
          } else {
            // Session expired
            localStorage.removeItem('currentUser');
            localStorage.removeItem('loginTime');
          }
        }
      } catch (error) {
        console.error('Error checking login status:', error);
      }
      
      return false;
    }

    // ============================================
    // SETUP EVENT LISTENERS
    // ============================================
    function setupEventListeners() {
      // Login form
      elements.password.addEventListener('keypress', function(e) {
        if (e.key === 'Enter') login();
      });
      
      // Time buttons
      elements.startTimeButton.addEventListener('click', startTime);
      elements.endTimeButton.addEventListener('click', endTime);
      
      // Logout buttons
      elements.logoutButton.addEventListener('click', (e) => {
        e.preventDefault();
        logout();
      });
      
      elements.logoutButtonBlocked.addEventListener('click', (e) => {
        e.preventDefault();
        logout();
      });
      
      // Password change
      elements.changePasswordButton.addEventListener('click', showPasswordChangeModal);
      elements.modalSavePasswordBtn.addEventListener('click', changePassword);
      elements.modalCancelPasswordBtn.addEventListener('click', closePasswordChangeModal);
      
      // Modal close on outside click
      elements.passwordChangeModal.addEventListener('click', (e) => {
        if (e.target === elements.passwordChangeModal) closePasswordChangeModal();
      });
      
      elements.popupOverlay.addEventListener('click', (e) => {
        if (e.target === elements.popupOverlay) hidePopup();
      });
      
      elements.maxLimitModal.addEventListener('click', (e) => {
        if (e.target === elements.maxLimitModal) closeMaxLimitModal();
      });
    }

    // ============================================
    // INITIALIZATION
    // ============================================
    document.addEventListener('DOMContentLoaded', function() {
      // Setup event listeners
      setupEventListeners();
      
      // Initialize clock
      updateClock();
      clockInterval = setInterval(updateClock, 1000);
      
      // Get user IP
      getUserIP();
      
      // Load background images
      loadBackgroundImages();
      
      // Check login status
      if (!checkLoginStatus()) {
        updateConnectionStatus(true, 'Connected - Please login');
      }
      
      // Test connection
      setTimeout(() => {
        updateConnectionStatus(true, 'Connected to Server');
      }, 2000);
      
      // Setup time restriction check
      setInterval(updateTimeRestriction, 30000);
      updateTimeRestriction();
      
      // Security: Disable right click and dev tools
      document.addEventListener('contextmenu', e => e.preventDefault());
      document.addEventListener('keydown', function(e) {
        if (e.key === 'F12' || 
            (e.ctrlKey && e.shiftKey && ['I', 'J', 'C'].includes(e.key)) || 
            (e.ctrlKey && e.key === 'U')) {
          e.preventDefault();
          showPopup(`<div style="color:#ff4757;text-align:center;">
            <i class="fas fa-ban fa-2x"></i><br>
            <strong>Akses Ditolak!</strong><br>
            <small>Developer tools tidak diizinkan</small>
          </div>`, 3000);
        }
      });
    });

    // ============================================
    // EXPORT FOR DEBUGGING
    // ============================================
    window.app = {
      currentUser,
      checkStartTimeLimit,
      updateStartCounterUI,
      isRestrictedTime,
      updateTimeRestriction,
      startTime,
      endTime,
      login,
      logout,
      showPasswordChangeModal,
      changePassword
    };

    console.log('Time Tracker System Ready with Role-based Limits!');

  </script>

</body>
</html>
